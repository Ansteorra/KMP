---
layout: default
---
[← Back to Development Workflow](7-development-workflow.md)

# Security Best Practices

**Last Updated:** November 4, 2025  
**Status:** Active

## Overview

This document consolidates security best practices, audit findings, and configuration guidelines for the KMP application. It covers both development and production security requirements.

## Table of Contents

- [Security Posture](#security-posture)
- [Cookie Configuration](#cookie-configuration)
- [CSRF Protection](#csrf-protection)
- [Security Headers](#security-headers)
- [Session Security](#session-security)
- [Development vs. Production](#development-vs-production)
- [Penetration Testing Results](#penetration-testing-results)
- [Security Checklist](#security-checklist)

## Security Posture

**Current Status:** EXCELLENT - All identified vulnerabilities resolved

Based on penetration testing conducted November 3, 2025:
- **Critical Vulnerabilities:** 0
- **High Risk Vulnerabilities:** 0 (1 false positive identified and cleared)
- **Medium Risk Vulnerabilities:** 0 (all fixed)
- **Low Risk Issues:** 0 (all fixed)
- **False Positives:** 1 (Mass Assignment - properly mitigated)

## Cookie Configuration

### Development Mode (debug=true)

**Purpose:** Support local development with HTTP, localhost, and IP address access.

**Settings:**
- `session.cookie_secure` = `false` - Allows HTTP
- `session.cookie_samesite` = `Lax` - Safari compatible
- `session.cookie_domain` = `''` - Works with localhost and IP addresses
- CSRF `secure` = `false` - Functions over HTTP
- CSRF `sameSite` = `Lax` - Cross-origin compatible

**Use Cases:**
- ✅ Access via localhost (http://localhost:8080)
- ✅ Access via IP address (http://192.168.0.253:8080)
- ✅ Works in Safari (strict cookie enforcement)
- ✅ No HTTPS required for development
- ✅ Test on local network devices

### Production Mode (debug=false)

**Purpose:** Maximum security for production deployment.

**Settings:**
- `session.cookie_secure` = `true` - HTTPS only
- `session.cookie_samesite` = `Strict` - Maximum CSRF protection
- `session.cookie_httponly` = `true` - Prevent JavaScript access
- `session.use_strict_mode` = `true` - Validate session IDs
- CSRF `secure` = `true` - HTTPS only
- CSRF `sameSite` = `Strict` - Maximum protection
- HSTS header enforced - 24-hour max-age

**Security Guarantees:**
- ✅ Session cookies only sent over HTTPS
- ✅ CSRF cookies only sent over HTTPS
- ✅ Strict SameSite policy prevents cross-site requests
- ✅ HTTP-only cookies prevent XSS attacks
- ✅ Strict session ID validation
- ✅ HSTS enforces HTTPS for 24 hours

### Configuration Files

**1. Application.php - CSRF Protection**

Location: `app/src/Application.php` (Lines 406-414)

```php
new CsrfProtectionMiddleware([
    'httponly' => true,    // Always prevent JavaScript access
    'secure' => !Configure::read('debug'),      // false in dev, true in prod
    'sameSite' => Configure::read('debug') ? 'Lax' : 'Strict',
])
```

**2. app_local.php - Session Configuration**

Location: `app/config/app_local.php` (Lines 36-49)

```php
'Session' => [
    'ini' => [
        'session.cookie_secure' => filter_var(env('DEBUG', true), FILTER_VALIDATE_BOOLEAN) ? false : true,
        'session.cookie_httponly' => true,
        'session.cookie_samesite' => filter_var(env('DEBUG', true), FILTER_VALIDATE_BOOLEAN) ? 'Lax' : 'Strict',
        'session.use_strict_mode' => true,
        'session.cookie_domain' => filter_var(env('DEBUG', true), FILTER_VALIDATE_BOOLEAN) ? '' : null,
    ],
],
```

**3. bootstrap.php - Security Validation**

Location: `app/config/bootstrap.php` (Lines 100-144)

Runtime security checks warn if production is running with insecure settings.

## CSRF Protection

**Middleware:** `CsrfProtectionMiddleware`

**Features:**
- Token validation on all POST/PUT/PATCH/DELETE requests
- HTTP-only cookies prevent JavaScript token theft
- Conditional secure flag based on environment
- SameSite protection against cross-site attacks

**Implementation:**
```php
// In Application.php middleware stack
->add(new CsrfProtectionMiddleware([
    'httponly' => true,
    'secure' => !Configure::read('debug'),
    'sameSite' => Configure::read('debug') ? 'Lax' : 'Strict',
]))
```

**Token Usage in Forms:**
```php
<?= $this->Form->create($entity) ?>
<!-- CSRF token automatically included -->
<?= $this->Form->end() ?>
```

## Security Headers

**Content Security Policy (CSP):**

Location: `app/src/Application.php` (Lines 340-390)

```php
$csp = "default-src 'self'; "
     . "script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; "
     . "style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com; "
     . "font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net data:; "
     . "img-src 'self' data: https://*.tile.openstreetmap.org https://*.openstreetmap.org; "
     . "connect-src 'self' https://*.tile.openstreetmap.org; "
     . "frame-ancestors 'none'; "
     . "base-uri 'self'; "
     . "form-action 'self';";

// Production only: upgrade insecure requests
if (!$isDevelopment) {
    $csp .= "; upgrade-insecure-requests";
}

$response = $response->withHeader('Content-Security-Policy', $csp);
```

**HTTP Strict Transport Security (HSTS):**

```php
// Production only
if (!$isDevelopment) {
    $response = $response->withHeader(
        'Strict-Transport-Security',
        'max-age=86400; includeSubDomains'
    );
}
```

**Other Security Headers:**
- `X-Frame-Options: DENY` - Prevent clickjacking
- `X-Content-Type-Options: nosniff` - Prevent MIME sniffing
- `Referrer-Policy: strict-origin-when-cross-origin` - Control referrer information

## Session Security

**Session Configuration:**

```php
'Session' => [
    'defaults' => 'php',
    'timeout' => 240,        // 4 hours
    'cookieTimeout' => 240,  // 4 hours
    'ini' => [
        'session.cookie_secure' => true,      // HTTPS only (in production)
        'session.cookie_httponly' => true,    // Prevent JavaScript access
        'session.cookie_samesite' => 'Strict', // CSRF protection (in production)
        'session.use_strict_mode' => true,    // Validate session IDs
        'session.cookie_path' => '/',
        'session.gc_maxlifetime' => 14400,    // 4 hours server-side
    ],
],
```

**Session Timeout:**
- Client-side: 4 hours (cookie timeout)
- Server-side: 4 hours (garbage collection)
- Idle timeout: Handled by cookie expiration

**Session Regeneration:**
- Automatic regeneration on login
- Prevents session fixation attacks
- Handled by CakePHP authentication plugin

## Development vs. Production

### Environment Configuration

**Development (.env):**
```bash
DEBUG=true
```

**Production (.env):**
```bash
DEBUG=false
```

### Security Differences

| Feature | Development | Production |
|---------|-------------|------------|
| **Session Cookie Secure** | `false` (HTTP allowed) | `true` (HTTPS only) |
| **Session SameSite** | `Lax` (Safari compatible) | `Strict` (maximum protection) |
| **CSRF Cookie Secure** | `false` | `true` |
| **CSRF SameSite** | `Lax` | `Strict` |
| **HSTS Header** | Not sent | Enforced (24 hours) |
| **CSP upgrade-insecure-requests** | Not included | Included |
| **Service Workers** | Gracefully degrade | Full support with HTTPS |

### Development Benefits

✅ **Browser Compatibility:**
- Works in Safari with strict cookie enforcement
- Works in all modern browsers
- No certificate warnings or errors

✅ **Network Flexibility:**
- Access via localhost (http://localhost:8080)
- Access via IP address (http://192.168.0.253:8080)
- Access via 127.0.0.1
- Test on mobile devices via local network

✅ **No HTTPS Required:**
- Develop without SSL certificates
- No mixed content warnings
- Faster iteration cycle

### Production Guarantees

✅ **CSRF Protection:**
- CSRF cookies only sent over HTTPS
- Strict SameSite policy
- HTTP-only cookies prevent JavaScript access

✅ **Session Security:**
- Session cookies only sent over HTTPS
- Strict SameSite policy
- Strict session ID validation

✅ **Transport Security:**
- HSTS header enforces HTTPS
- CSP automatically upgrades HTTP to HTTPS
- All security headers active

✅ **Validation:**
- Runtime checks warn if misconfigured
- Logs document security mode
- Prevents accidental insecure deployment

## Penetration Testing Results

### Test Overview

**Date:** November 3, 2025  
**Scope:** HTTP surface security testing  
**Test Accounts:** Various privilege levels (basic user through super user)  
**Result:** All vulnerabilities resolved or verified as false positives

### Findings Summary

#### VULN-001: Mass Assignment (FALSE POSITIVE)

**Status:** ✅ NOT A VULNERABILITY

**Initial Concern:** Member entity's `$_accessible` array appeared to allow modification of sensitive fields.

**Actual Finding:** Application properly segregates user-level and admin-level edits:

1. **Separate Controller Actions:**
   - `partialEdit()` - Users editing themselves (manual field assignment)
   - `edit()` - Administrators with elevated permissions (uses patchEntity)

2. **Authorization Enforcement:**
   - Regular users can only `partialEdit` themselves
   - Policy check: `MemberPolicy::canPartialEdit()` validates user owns record
   - Admin edit requires `canEdit` permission

3. **Manual Field Assignment in partialEdit():**
   ```php
   public function partialEdit($id = null) {
       $member = $this->Members->get($id);
       $this->Authorization->authorize($member);
       
       if ($this->request->is(['patch', 'post', 'put'])) {
           // SECURE: Manually sets ONLY allowed fields
           $member->title = $this->request->getData('title');
           $member->sca_name = $this->request->getData('sca_name');
           // ... only safe fields assigned
           
           // Sensitive fields (status, membership_expires_on) are NOT assigned
           // even if attacker submits them
       }
   }
   ```

**Defense in Depth:**
- ✅ Separate actions for different privilege levels
- ✅ Manual field assignment (no mass assignment risk)
- ✅ Authorization policy enforcement
- ✅ Route-level access control

#### VULN-002: Duplicate HTML IDs (FIXED)

**Status:** ✅ FIXED  
**Severity:** Medium (was accessibility issue, not security)

**Issue:** Multiple modal elements using same IDs caused accessibility problems.

**Fix:** Updated modal IDs to be unique per context.

#### VULN-003: Autocomplete Attributes (FIXED)

**Status:** ✅ FIXED  
**Severity:** Low (password management UX)

**Issue:** Missing autocomplete attributes on password fields.

**Fix:** Added proper autocomplete attributes:
- Login: `autocomplete="current-password"`
- Registration: `autocomplete="new-password"`
- Password change: Appropriate attributes per field

### Security Testing Best Practices

**Regular Testing:**
- Run penetration tests before major releases
- Test with multiple privilege levels
- Verify authorization at every endpoint
- Test both authenticated and public access

**Automated Security Checks:**
```bash
# Dependency vulnerability scanning
composer audit

# PHP security checker
./security-checker.sh
```

## Security Checklist

### Pre-Deployment

- [ ] Set `DEBUG=false` in production .env
- [ ] Verify HTTPS is configured on web server
- [ ] Check application logs for security warnings
- [ ] Test that cookies are marked `Secure` in browser dev tools
- [ ] Verify HSTS header is present in responses
- [ ] Confirm login works over HTTPS only
- [ ] Run `composer audit` for dependency vulnerabilities
- [ ] Review and update CSP headers as needed

### Development Setup

- [ ] Set `DEBUG=true` in .env
- [ ] Verify cookies work over HTTP
- [ ] Test in Safari for compatibility
- [ ] Test on mobile devices via IP address
- [ ] Check browser console for CSP violations

### Code Review Security Checks

**Controller Actions:**
- [ ] All actions have authorization checks
- [ ] Manual field assignment for user-editable forms
- [ ] patchEntity only used with proper $_accessible configuration
- [ ] CSRF protection enabled for POST/PUT/PATCH/DELETE
- [ ] Input validation on all user-provided data

**Templates:**
- [ ] Output properly escaped (automatic via CakePHP helpers)
- [ ] No direct `echo` of user input without escaping
- [ ] Forms use `$this->Form->create()` for CSRF tokens
- [ ] Links use `$this->Html->link()` for proper escaping

**Policies:**
- [ ] Authorization checks at both table and entity level
- [ ] Branch scoping enforced where appropriate
- [ ] Temporal validation for time-sensitive permissions
- [ ] Proper fallback to deny access if unsure

**Database:**
- [ ] Parameterized queries (ORM handles this)
- [ ] No raw SQL with user input
- [ ] Proper foreign key constraints
- [ ] Soft deletes instead of hard deletes for audit trail

### Incident Response

**If Security Issue Discovered:**

1. **Assess Severity:**
   - Critical: Immediate fix required
   - High: Fix within 24 hours
   - Medium: Fix in next release
   - Low: Fix as time permits

2. **Document:**
   - What the vulnerability is
   - How it was discovered
   - What data/systems are affected
   - What actions have been taken

3. **Fix and Test:**
   - Implement fix
   - Add test case to prevent regression
   - Verify fix doesn't introduce new issues
   - Document fix in code comments

4. **Deploy:**
   - Emergency deployment for critical issues
   - Include in next scheduled release for lower severity
   - Update security documentation

5. **Review:**
   - Conduct post-mortem
   - Update security practices
   - Add to testing checklist

## Testing Security

### Manual Security Testing

**Authentication:**
```bash
# Test login
curl -c cookies.txt -d "username=test@example.com&password=wrong" \
  https://example.com/members/login

# Verify session cookie has Secure flag
cat cookies.txt | grep "Secure"

# Test protected endpoint without auth (should fail)
curl -b cookies.txt https://example.com/members/index
```

**Authorization:**
- Test each endpoint with different user privilege levels
- Verify branch scoping limits data access
- Test policy checks prevent unauthorized actions
- Verify temporal validation rejects expired warrants

**CSRF Protection:**
```bash
# Test POST without CSRF token (should fail)
curl -X POST -b cookies.txt https://example.com/members/add

# Test with invalid CSRF token (should fail)
curl -X POST -b cookies.txt -d "_csrfToken=invalid&..." \
  https://example.com/members/add
```

### Automated Security Scanning

**Composer Audit:**
```bash
cd app
composer audit
```

**Security Checker:**
```bash
./security-checker.sh
```

**CodeQL (if configured):**
```bash
# Run CodeQL analysis
codeql database analyze
```

## Related Documentation

- [RBAC Security Architecture](4.4-rbac-security-architecture.md) - Detailed authorization system
- [Development Workflow](7-development-workflow.md) - Development best practices
- [Deployment](8-deployment.md) - Production deployment procedures

---

## Quick Reference

**Development Mode:**
```bash
# .env
DEBUG=true

# Allows HTTP, works with Safari, IP addresses
```

**Production Mode:**
```bash
# .env
DEBUG=false

# Requires HTTPS, maximum security
```

**Security Audit:**
- Status: EXCELLENT
- Last Test: November 3, 2025
- Critical Issues: 0
- All vulnerabilities resolved

**Key Security Features:**
- ✅ CSRF protection with secure cookies
- ✅ Session security with strict validation
- ✅ CSP headers with proper directives
- ✅ HSTS enforcement in production
- ✅ Defense in depth authorization
- ✅ Temporal warrant validation
