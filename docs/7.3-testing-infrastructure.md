---
layout: default
---
[← Back to Development Workflow](7-development-workflow.md)

# 7.3 Testing Infrastructure

**Last Updated:** November 4, 2025  
**Purpose:** Comprehensive guide to KMP's testing framework, fixtures, and best practices

## Overview

KMP uses PHPUnit for testing with CakePHP's testing framework. This section covers the testing infrastructure, including fixtures, authentication helpers, and best practices for writing tests.

## Test Super User System

### Purpose

The Test Super User fixture system provides a consistent, reusable way to authenticate tests with full system permissions. This eliminates permission-related test failures and makes tests more maintainable.

### Components

#### 1. TestSuperUser Fixtures

**Core Fixtures:**
- `TestSuperUserFixture.php` - Creates the test super user member
- `TestSuperUserRoleFixture.php` - Creates the "TestSuperUser" role
- `TestSuperUserRolePermissionFixture.php` - Links role to "Is Super User" permission
- `TestSuperUserMemberRoleFixture.php` - Assigns role to test super user

**Test Super User Details:**

| Property | Value |
|----------|-------|
| **Email** | `testsuper@test.com` |
| **Password** | `Password123` (MD5) |
| **ID** | `2` |
| **SCA Name** | `Test Super User` |
| **Role** | `TestSuperUser` (ID: 2) |
| **Permission** | `Is Super User` (ID: 1) |
| **Branch** | Kingdom (ID: 1) |
| **Status** | `verified` |
| **Membership Expires** | `2100-01-01` |
| **Background Check Expires** | `2100-01-01` |

#### 2. SuperUserAuthenticatedTrait

**Location:** `tests/TestCase/Controller/SuperUserAuthenticatedTrait.php`

Automatically authenticates all tests as the test super user in the `setUp()` method.

**Usage:**
```php
<?php
namespace App\Test\TestCase\Controller;

use App\Test\TestCase\Controller\SuperUserAuthenticatedTrait;
use Cake\TestSuite\TestCase;

class MyControllerTest extends TestCase
{
    use SuperUserAuthenticatedTrait;

    protected array $fixtures = [
        'app.Branches',
        'app.Permissions',
        'app.Roles',
        'app.Members',
        'app.RolesPermissions',
        'app.MemberRoles',
        'app.TestSuperUser',
        'app.TestSuperUserRole',
        'app.TestSuperUserRolePermission',
        'app.TestSuperUserMemberRole',
    ];

    public function testIndex(): void
    {
        // Already authenticated as super user!
        $this->get('/protected/route');
        $this->assertResponseOk();
    }
}
```

#### 3. TestAuthenticationHelper

**Location:** `tests/TestCase/TestAuthenticationHelper.php`

Provides helper methods for manual authentication in tests.

**Available Methods:**

```php
// Authentication
$this->authenticateAsSuperUser();
$this->authenticateAsAdmin();
$this->authenticateAsMember($memberId);
$this->logout();

// Assertions
$this->assertAuthenticated();
$this->assertNotAuthenticated();
$this->assertAuthenticatedAs($memberId);

// Getters
$id = $this->getAuthenticatedMemberId();
$email = $this->getAuthenticatedMemberEmail();
```

**Usage Example:**
```php
<?php
namespace App\Test\TestCase\Controller;

namespace App\Test\TestCase\Controller;

use App\Test\TestCase\TestAuthenticationHelper;
use Cake\TestSuite\IntegrationTestTrait;
use Cake\TestSuite\TestCase;

class MyControllerTest extends TestCase
{
    use IntegrationTestTrait;
    use TestAuthenticationHelper;

    protected array $fixtures = [
        // ... same fixtures as above ...
    ];

    public function testAsAdmin(): void
    {
        $this->authenticateAsAdmin();
        $this->get('/admin/route');
        $this->assertResponseOk();
    }

    public function testAsSuperUser(): void
    {
        $this->authenticateAsSuperUser();
        $this->get('/super-secure/route');
        $this->assertResponseOk();
    }

    public function testAsSpecificMember(): void
    {
        $this->authenticateAsMember(3);
        $this->get('/member/route');
        $this->assertResponseOk();
    }
}
```

### Required Fixtures (in order)

When using the test super user system, load fixtures in this order:

1. `app.Branches` - Provides Kingdom branch
2. `app.Permissions` - Provides "Is Super User" permission
3. `app.Roles` - Provides Admin role
4. `app.TestSuperUserRole` - Creates TestSuperUser role
5. `app.Members` - Provides Admin member
6. `app.TestSuperUser` - Creates test super user member
7. `app.RolesPermissions` - Links roles to permissions
8. `app.TestSuperUserRolePermission` - Links TestSuperUser to "Is Super User"
9. `app.MemberRoles` - Links members to roles
10. `app.TestSuperUserMemberRole` - Links test super user to TestSuperUser role

### Common Patterns

#### Pattern 1: Automatic Authentication (Recommended)
```php
class MyTest extends TestCase
{
    use SuperUserAuthenticatedTrait;
    
    // All tests auto-authenticated with full permissions!
    public function testSomething(): void
    {
        $this->get('/protected');
        $this->assertResponseOk();
    }
}
```

#### Pattern 2: Manual Authentication
```php
class MyTest extends TestCase
{
    use IntegrationTestTrait;
    use TestAuthenticationHelper;
    
    public function testSomething(): void
    {
        $this->authenticateAsSuperUser();
        $this->get('/protected');
        $this->assertResponseOk();
    }
}
```

#### Pattern 3: Session-based Authentication
```php
public function testSomething(): void
{
    $this->session([
        'Auth' => [
            'id' => 2,
            'email_address' => 'testsuper@test.com',
            'sca_name' => 'Test Super User',
        ]
    ]);
    $this->get('/protected');
    $this->assertResponseOk();
}
```

### Troubleshooting

#### "Seed file not found" Error

**Symptom:** Fixture loading fails with "Seed file not found" error

**Solution:** Update fixtures to make optional seeds optional:
```php
$this->getData('SeedName', null, true); // 3rd param = optional
```

#### Getting 302 Redirects

**Symptom:** Tests get redirected instead of accessing protected routes

**Solution:** Ensure permissions are loaded on member entity. Check that `SuperUserAuthenticatedTrait` properly loads permissions in `setUp()`.

#### Wrong IDs

**Symptom:** Test fails because fixture IDs don't match expected values

**Solution:** Check fixture loading order. Ensure dependencies load before fixtures that reference them.

#### Permission Denied

**Symptom:** User authenticated but still getting permission denied

**Solution:** 
1. Verify "Is Super User" permission exists and has `is_super_user = 1`
2. Check that `TestSuperUserRolePermission` properly links role to permission
3. Verify member has the TestSuperUser role assigned

## Case Study: Phase 3 Test Fixes

### Background

During Phase 3 testing of the Waiver plugin (User Story 1: Configure Waiver Types), multiple test failures were encountered related to infrastructure issues rather than implementation bugs.

**Initial State:**
- Total tests: 68
- Errors: 16
- Failures: 24
- Total issues: 40 (59% failure rate)

### Problems Identified

#### 1. ServiceResult API Issues

**Problem:** Tests expected fluent API methods that didn't exist on ServiceResult class.

**Missing Methods:**
- `isSuccess()` - Check operation success
- `getData()` - Get data payload
- `getError()` - Get error message

**Solution:** Added three convenience methods to `ServiceResult` class:

```php
// File: src/Services/ServiceResult.php

/**
 * Check if the service operation was successful
 */
public function isSuccess(): bool
{
    return $this->success;
}

/**
 * Get the data payload
 */
public function getData()
{
    return $this->data;
}

/**
 * Get the error message
 */
public function getError(): ?string
{
    return $this->reason;
}
```

**Impact:** All services throughout KMP now have a consistent, fluent API.

#### 2. Database Schema Issues

**Problem:** `WaiverTypesTable` had association to `Documents` table via `document_id` column that doesn't exist yet (future feature). This caused SQL errors when trying to load Documents.

**Solution:** Commented out Documents association with TODO marker:

```php
// File: plugins/Waivers/src/Model/Table/WaiverTypesTable.php

// TODO: Uncomment when Documents table and document_id column are implemented
// $this->belongsTo('Documents', [
//     'className' => 'Documents',
//     'foreignKey' => 'document_id',
//     'joinType' => 'LEFT',
// ]);
```

Removed Documents from `contain` in controller:

```php
// File: plugins/Waivers/src/Controller/WaiverTypesController.php

// Before:
$waiverType = $this->WaiverTypes->get($id, contain: ['Documents']);

// After:
// TODO: Add back 'Documents' contain when table exists
$waiverType = $this->WaiverTypes->get($id);
```

**Impact:** Tests can run without database schema errors.

#### 3. RetentionPolicyService Issues

**Problem:** Service and tests had mismatched expectations for JSON format.

**Issues:**
- Service expected flat format: `{"anchor":"...","years":2}`
- Tests used nested format: `{"anchor":"...","duration":{"years":2}}`
- Permanent retention returned far-future date instead of null
- Missing `getHumanReadableDescription()` method

**Solutions:**

*Support Both Formats:*
```php
// Extract duration - support both nested and flat
$duration = $policy['duration'] ?? $policy;
$years = $duration['years'] ?? 0;
$months = $duration['months'] ?? 0;
$days = $duration['days'] ?? 0;
```

*Fix Permanent Retention:*
```php
if ($policy['anchor'] === 'permanent') {
    // Permanent retention returns null (no expiration)
    return new ServiceResult(true, null, null);
}
```

*Add Human-Readable Method:*
```php
public function getHumanReadableDescription(string $policyJson): string
{
    // ... implementation ...
    return 'Retain for ' . $durationText . ' after ' . $anchorText;
}
```

**Impact:** Service matches test expectations and provides better API.

#### 4. Test Authentication Issues

**Problem:** `WaiverTypesControllerTest` used `AuthenticatedTrait` (regular member with limited permissions) instead of super user trait.

**Solution:** Changed to `SuperUserAuthenticatedTrait` and added proper fixtures:

```php
// Before:
use App\Test\TestCase\Controller\AuthenticatedTrait;

class WaiverTypesControllerTest extends TestCase
{
    use AuthenticatedTrait;

    protected array $fixtures = [
        'app.Branches',
        'app.Members',
        // ... missing test super user fixtures
    ];
}

// After:
use App\Test\TestCase\Controller\SuperUserAuthenticatedTrait;

class WaiverTypesControllerTest extends TestCase
{
    use SuperUserAuthenticatedTrait;

    protected array $fixtures = [
        'app.Branches',
        'app.Permissions',  // Order matters!
        'app.Roles',
        'app.RolesPermissions',
        'app.Members',
        'app.MemberRoles',
        'app.TestSuperUser',
        'app.TestSuperUserRole',
        'app.TestSuperUserRolePermission',
        'app.TestSuperUserMemberRole',
        'app.Warrants',
        'plugin.Waivers.WaiverTypes',
    ];
}
```

**Impact:** Tests run with full permissions, eliminating authorization errors.

### Final Results

**After Fixes:**
- Total: 51 tests (Phase 3 only)
- Passing: 37 (73%)
- Failing: 14 (27%)
- Errors: 0 (100% reduction)
- **Overall Improvement:** 65% reduction in failures/errors

**Test Breakdown:**
- ✅ Model Tests: 18/18 passing (100%)
- ✅ Service Tests: 16/16 passing (100%)
- ⚠️ Controller Tests: 3/17 passing (remaining issues are environmental/CSRF-related)

### Lessons Learned

1. **ServiceResult Enhancement:** Fluent API methods improve usability across entire codebase
2. **Future Features:** Comment out associations for features not yet implemented
3. **Service Flexibility:** Support multiple input formats when reasonable
4. **Test Authentication:** Use `SuperUserAuthenticatedTrait` for tests requiring full permissions
5. **Fixture Loading Order:** Order matters! Dependencies must load first

## Testing Best Practices

### 1. Use Fixtures Appropriately

**Good:**
```php
protected array $fixtures = [
    'app.Branches',        // Required for basic data
    'app.Members',         // Required for authentication
    'app.TestSuperUser',   // Required for super user tests
    'plugin.MyPlugin.MyTable',  // Required for plugin tests
];
```

**Bad:**
```php
protected array $fixtures = [
    // Loading everything "just in case"
    'app.*',
    'plugin.*',
];
```

### 2. Make Seeds Optional When Appropriate

If a seed file might not exist in all environments:

```php
// In BaseTestFixture or custom fixture
protected function getData(string $seed, ?string $plugin = null, bool $optional = false): array
{
    // ... implementation that handles optional = true gracefully
}
```

### 3. Test One Thing at a Time

**Good:**
```php
public function testAddCreatesNewRecord(): void
{
    $data = ['name' => 'Test'];
    $this->post('/resource/add', $data);
    $this->assertResponseSuccess();
    
    $record = $this->Table->find()->where(['name' => 'Test'])->first();
    $this->assertNotNull($record);
}
```

**Bad:**
```php
public function testEverything(): void
{
    // Testing add, edit, delete, view all in one test
}
```

### 4. Use Descriptive Test Names

**Good:**
```php
public function testAddWithValidDataCreatesRecord(): void
public function testEditWithInvalidPermissionsReturnsForbidden(): void
public function testDeleteRemovesRecordFromDatabase(): void
```

**Bad:**
```php
public function testAdd(): void
public function test1(): void
public function testStuff(): void
```

### 5. Clean Up After Tests

**Good:**
```php
public function tearDown(): void
{
    // Clean up any temp files, connections, etc.
    parent::tearDown();
}
```

### 6. Use Data Providers for Similar Tests

```php
/**
 * @dataProvider invalidDataProvider
 */
public function testValidationWithInvalidData($data, $expectedError): void
{
    $result = $this->service->validate($data);
    $this->assertFalse($result->isSuccess());
    $this->assertStringContainsString($expectedError, $result->getError());
}

public function invalidDataProvider(): array
{
    return [
        'empty name' => [['name' => ''], 'Name cannot be empty'],
        'invalid email' => [['email' => 'notanemail'], 'Invalid email format'],
        'negative number' => [['count' => -1], 'Count must be positive'],
    ];
}
```

## Running Tests

### Run All Tests
```bash
cd app
vendor/bin/phpunit
```

### Run Specific Test File
```bash
vendor/bin/phpunit tests/TestCase/Controller/MembersControllerTest.php
```

### Run Specific Test Method
```bash
vendor/bin/phpunit --filter testIndex tests/TestCase/Controller/MembersControllerTest.php
```

### Run Tests with Coverage
```bash
vendor/bin/phpunit --coverage-html coverage/
```

### Run Plugin Tests
```bash
vendor/bin/phpunit plugins/MyPlugin/tests/
```

## Test Organization

```
app/tests/
├── bootstrap.php           # Test bootstrap configuration
├── Fixture/               # Test fixtures (database seeds)
│   ├── BaseTestFixture.php
│   ├── MembersFixture.php
│   ├── TestSuperUserFixture.php
│   └── ...
├── TestCase/              # Test cases
│   ├── Controller/        # Controller tests
│   │   ├── AuthenticatedTrait.php
│   │   ├── SuperUserAuthenticatedTrait.php
│   │   ├── MembersControllerTest.php
│   │   └── ...
│   ├── Model/             # Model tests
│   │   ├── Table/
│   │   └── Entity/
│   ├── Services/          # Service tests
│   └── TestAuthenticationHelper.php
└── tmp/                   # Temporary test files
```

## Additional Resources

- **Full Test Super User Documentation:** See `app/tests/Fixture/` directory for fixture implementations
- **CakePHP Testing Documentation:** https://book.cakephp.org/4/en/development/testing.html
- **PHPUnit Documentation:** https://phpunit.de/documentation.html

---

[← Back to Development Workflow](7-development-workflow.md)
