# 3.5 Entity Relationship Diagrams

## Overview

This document provides comprehensive Entity Relationship (ER) diagrams for the KMP (Kingdom Management Platform) database schema. The diagrams illustrate the complex relationships between entities across the core system and plugin extensions.

## Core System ER Diagram

### Members and Authentication

```mermaid
erDiagram
    members {
        int id PK
        varchar sca_name
        varchar first_name
        varchar last_name
        varchar email_address UK
        varchar password
        varchar membership_number
        date membership_expires_on
        int branch_id FK
        int parent_id FK
        varchar status
        datetime verified_date
        int verified_by FK
        varchar title
        varchar pronouns
        varchar pronunciation
        boolean warrantable
        json additional_info
        datetime created
        datetime modified
        int created_by FK
        int modified_by FK
        datetime deleted
    }
    
    branches {
        int id PK
        varchar name UK
        varchar location
        int parent_id FK
        varchar type
        varchar domain
        text links
        boolean can_have_members
        int lft
        int rght
        datetime created
        datetime modified
        int created_by FK
        int modified_by FK
        datetime deleted
    }
    
    members ||--o{ members : "parent_child"
    members }o--|| branches : "member_branch"
    branches ||--o{ branches : "parent_child"
    members ||--o{ members : "verified_by"
```

### Role-Based Access Control (RBAC)

```mermaid
erDiagram
    roles {
        int id PK
        varchar name UK
        boolean is_system
        datetime created
        datetime modified
        int created_by FK
        int modified_by FK
        datetime deleted
    }
    
    permissions {
        int id PK
        varchar name UK
        boolean require_active_membership
        boolean require_active_background_check
        int require_min_age
        boolean is_system
        boolean is_super_user
        boolean requires_warrant
        varchar scoping_rule
        datetime created
        datetime modified
        int created_by FK
        int modified_by FK
        datetime deleted
    }
    
    roles_permissions {
        int id PK
        int role_id FK
        int permission_id FK
        timestamp created
        int created_by FK
    }
    
    member_roles {
        int id PK
        int member_id FK
        int role_id FK
        int branch_id FK
        varchar entity_type
        int entity_id
        datetime start_on
        datetime expires_on
        varchar status
        int approver_id FK
        int revoker_id FK
        datetime created
        datetime modified
        int created_by FK
        int modified_by FK
        datetime deleted
    }
    
    permission_policies {
        int id PK
        int permission_id FK
        varchar policy_class
        varchar policy_method
        datetime created
        datetime modified
    }
    
    roles ||--o{ roles_permissions : "role_permissions"
    permissions ||--o{ roles_permissions : "permission_roles"
    permissions ||--o{ permission_policies : "permission_policies"
    members ||--o{ member_roles : "member_roles"
    roles ||--o{ member_roles : "role_assignments"
    branches ||--o{ member_roles : "branch_roles"
    members ||--o{ member_roles : "approver"
    members ||--o{ member_roles : "revoker"
```

### Warrant System

```mermaid
erDiagram
    warrant_periods {
        int id PK
        date start_date
        date end_date
        datetime created
        int created_by FK
    }
    
    warrants {
        int id PK
        varchar name
        int member_id FK
        int warrant_roster_id FK
        varchar entity_type
        int entity_id
        int member_role_id FK
        datetime start_on
        datetime expires_on
        datetime approved_date
        int approver_id FK
        text revoked_reason
        int revoker_id FK
        varchar status
        varchar warrant_number
        datetime created
        datetime modified
        int created_by FK
        int modified_by FK
        datetime deleted
    }
    
    warrant_periods ||--o{ warrants : "warrant_period"
    members ||--o{ warrants : "warrant_holder"
    member_roles ||--o{ warrants : "warrant_role"
    members ||--o{ warrants : "warrant_approver"
    members ||--o{ warrants : "warrant_revoker"
```

### Notes and Configuration

```mermaid
erDiagram
    notes {
        int id PK
        int author_id FK
        varchar entity_type
        int entity_id
        varchar subject
        text body
        boolean private
        timestamp created
    }
    
    app_settings {
        int id PK
        varchar name UK
        text value
        varchar type
        boolean required
        datetime created
        datetime modified
        int created_by FK
        int modified_by FK
    }
    
    members ||--o{ notes : "note_creator"
    members ||--o{ notes : "note_modifier"
```

## Officers Plugin ER Diagram

### Organizational Structure

```mermaid
erDiagram
    officers_departments {
        int id PK
        varchar name UK
        text description
        datetime created
        datetime modified
        int created_by FK
        int modified_by FK
        datetime deleted
    }
    
    officers_offices {
        int id PK
        varchar name UK
        int department_id FK
        boolean requires_warrant
        boolean required_office
        boolean only_one_per_branch
        boolean can_skip_report
        int deputy_to_id FK
        int reports_to_id FK
        int grants_role_id FK
        int term_length
        varchar applicable_branch_types
        varchar default_contact_address
        datetime created
        datetime modified
        int created_by FK
        int modified_by FK
        datetime deleted
    }
    
    officers_officers {
        int id PK
        int member_id FK
        int branch_id FK
        int office_id FK
        int granted_member_role_id FK
        datetime start_on
        datetime expires_on
        varchar status
        text deputy_description
        text revoked_reason
        int revoker_id FK
        int deputy_to_branch_id FK
        int deputy_to_office_id FK
        int reports_to_branch_id FK
        int reports_to_office_id FK
        varchar email_address
        int approver_id FK
        datetime created
        datetime modified
        int created_by FK
        int modified_by FK
        datetime deleted
    }
    
    officers_departments ||--o{ officers_offices : "department_offices"
    officers_offices ||--o{ officers_offices : "deputy_to"
    officers_offices ||--o{ officers_offices : "reports_to"
    roles ||--o{ officers_offices : "grants_role"
    officers_offices ||--o{ officers_officers : "office_assignments"
    members ||--o{ officers_officers : "officer_member"
    branches ||--o{ officers_officers : "officer_branch"
    member_roles ||--o{ officers_officers : "granted_role"
    members ||--o{ officers_officers : "approver"
    members ||--o{ officers_officers : "revoker"
    branches ||--o{ officers_officers : "deputy_to_branch"
    officers_offices ||--o{ officers_officers : "deputy_to_office"
    branches ||--o{ officers_officers : "reports_to_branch"
    officers_offices ||--o{ officers_officers : "reports_to_office"
```

## Awards Plugin ER Diagram

### Award Classification System

```mermaid
erDiagram
    awards_domains {
        int id PK
        varchar name UK
        text description
        datetime created
        datetime modified
        int created_by FK
        int modified_by FK
        datetime deleted
    }
    
    awards_levels {
        int id PK
        varchar name UK
        int precedence
        datetime created
        datetime modified
        int created_by FK
        int modified_by FK
        datetime deleted
    }
    
    awards_awards {
        int id PK
        varchar name
        varchar abbreviation
        text description
        text insignia
        text badge
        text charter
        int domain_id FK
        int level_id FK
        int branch_id FK
        json specialties
        datetime created
        datetime modified
        int created_by FK
        int modified_by FK
        datetime deleted
    }
    
    awards_domains ||--o{ awards_awards : "award_domain"
    awards_levels ||--o{ awards_awards : "award_level"
    branches ||--o{ awards_awards : "award_branch"
```

### Recommendation and Event System

```mermaid
erDiagram
    awards_events {
        int id PK
        varchar name
        text description
        datetime event_date
        datetime recommend_by_date
        int branch_id FK
        datetime created
        datetime modified
        int created_by FK
        int modified_by FK
        datetime deleted
    }
    
    awards_recommendations {
        int id PK
        int requester_id FK
        int member_id FK
        int award_id FK
        int branch_id FK
        int event_id FK
        text reason
        varchar specialty
        text contact_info
        varchar member_name
        int stack_rank
        varchar state
        datetime created
        datetime modified
        int created_by FK
        int modified_by FK
        datetime deleted
    }
    
    awards_recommendations_events {
        int id PK
        int recommendation_id FK
        int event_id FK
    }
    
    awards_recommendations_states_log {
        int id PK
        int recommendation_id FK
        varchar old_state
        varchar new_state
        text reason
        datetime created
        int created_by FK
    }
    
    branches ||--o{ awards_events : "event_branch"
    members ||--o{ awards_recommendations : "requester"
    members ||--o{ awards_recommendations : "recommended_member"
    awards_awards ||--o{ awards_recommendations : "recommended_award"
    branches ||--o{ awards_recommendations : "recommendation_branch"
    awards_events ||--o{ awards_recommendations : "assigned_event"
    awards_recommendations ||--o{ awards_recommendations_events : "recommendation_events"
    awards_events ||--o{ awards_recommendations_events : "event_recommendations"
    awards_recommendations ||--o{ awards_recommendations_states_log : "state_changes"
```

## Activities Plugin ER Diagram

### Activity Authorization System

```mermaid
erDiagram
    activities_activity_groups {
        int id PK
        varchar name UK
        text description
        datetime created
        datetime modified
        int created_by FK
        int modified_by FK
        datetime deleted
    }
    
    activities_activities {
        int id PK
        varchar name
        text description
        int activity_group_id FK
        int grants_role_id FK
        int permission_id FK
        datetime created
        datetime modified
        int created_by FK
        int modified_by FK
        datetime deleted
    }
    
    activities_authorizations {
        int id PK
        int member_id FK
        int activity_id FK
        int granted_member_role_id FK
        datetime start_on
        datetime expires_on
        varchar status
        text revoked_reason
        int revoker_id FK
        datetime created
        datetime modified
        int created_by FK
        int modified_by FK
        datetime deleted
    }
    
    activities_authorization_approvals {
        int id PK
        int authorization_id FK
        int approver_id FK
        varchar status
        text reason
        datetime created
        datetime modified
        int created_by FK
        int modified_by FK
        datetime deleted
    }
    
    activities_activity_groups ||--o{ activities_activities : "activity_group"
    roles ||--o{ activities_activities : "grants_role"
    permissions ||--o{ activities_activities : "activity_permission"
    members ||--o{ activities_authorizations : "authorized_member"
    activities_activities ||--o{ activities_authorizations : "activity_authorization"
    member_roles ||--o{ activities_authorizations : "granted_role"
    members ||--o{ activities_authorizations : "revoker"
    activities_authorizations ||--o{ activities_authorization_approvals : "authorization_approvals"
    members ||--o{ activities_authorization_approvals : "approval_member"
```

## System Integration Diagram

### Cross-Plugin Relationships

```mermaid
erDiagram
    %% Core System
    members {
        int id PK
        varchar sca_name
        varchar email_address UK
        int branch_id FK
        boolean warrantable
    }
    
    branches {
        int id PK
        varchar name UK
        varchar type
        int parent_id FK
    }
    
    member_roles {
        int id PK
        int member_id FK
        int role_id FK
        int branch_id FK
        datetime start_on
        datetime expires_on
        varchar status
    }
    
    warrants {
        int id PK
        int member_id FK
        varchar entity_type
        int entity_id
        int member_role_id FK
        varchar status
    }
    
    %% Officers Plugin
    officers_officers {
        int id PK
        int member_id FK
        int branch_id FK
        int office_id FK
        int granted_member_role_id FK
        varchar status
    }
    
    %% Awards Plugin
    awards_recommendations {
        int id PK
        int member_id FK
        int award_id FK
        int branch_id FK
        varchar state
    }
    
    %% Activities Plugin
    activities_authorizations {
        int id PK
        int member_id FK
        int activity_id FK
        int granted_member_role_id FK
        varchar status
    }
    
    %% Cross-plugin relationships
    members ||--o{ officers_officers : "officer_assignments"
    members ||--o{ awards_recommendations : "award_recommendations"
    members ||--o{ activities_authorizations : "activity_authorizations"
    branches ||--o{ officers_officers : "officer_branches"
    branches ||--o{ awards_recommendations : "recommendation_branches"
    member_roles ||--o{ officers_officers : "officer_roles"
    member_roles ||--o{ activities_authorizations : "authorization_roles"
    warrants ||--o{ officers_officers : "warrant_entities"
    warrants ||--o{ activities_authorizations : "warrant_entities"
```

## Temporal Relationship Patterns

### ActiveWindow Entities

Many entities in KMP use the ActiveWindow pattern for temporal management:

```mermaid
erDiagram
    temporal_entity {
        int id PK
        datetime start_on
        datetime expires_on
        varchar status
        datetime created
        datetime modified
    }
    
    %% Status transitions based on time
    %% new -> upcoming -> current -> expired
    %% new -> upcoming -> current -> revoked
```

**Status Lifecycle**:
1. `new`: Created but not yet active
2. `upcoming`: Future activation date set
3. `current`: Currently active (between start_on and expires_on)
4. `expired`: Past expiration date
5. `revoked`: Manually terminated before expiration

### Audit Trail Pattern

All major entities include comprehensive audit trails:

```mermaid
erDiagram
    auditable_entity {
        int id PK
        datetime created
        datetime modified
        int created_by FK
        int modified_by FK
        datetime deleted
    }
    
    members {
        int id PK
    }
    
    auditable_entity }o--|| members : "created_by"
    auditable_entity }o--|| members : "modified_by"
```

## Polymorphic Relationships

### Notes System

The notes system uses polymorphic associations to attach to any entity:

```mermaid
erDiagram
    notes {
        int id PK
        varchar topic_model
        int topic_id
        varchar subject
        text body
        boolean private
    }
    
    members {
        int id PK
    }
    
    awards_recommendations {
        int id PK
    }
    
    officers_officers {
        int id PK
    }
    
    notes }o--|| members : "when topic_model = 'Members'"
    notes }o--|| awards_recommendations : "when topic_model = 'Awards.Recommendations'"
    notes }o--|| officers_officers : "when topic_model = 'Officers.Officers'"
```

### Warrant System

Warrants can be assigned to various entity types:

```mermaid
erDiagram
    warrants {
        int id PK
        varchar entity_type
        int entity_id
        int member_id FK
        varchar status
    }
    
    officers_officers {
        int id PK
    }
    
    activities_authorizations {
        int id PK
    }
    
    warrants }o--|| officers_officers : "when entity_type = 'Officers.Officers'"
    warrants }o--|| activities_authorizations : "when entity_type = 'Activities.Authorizations'"
```

## JSON Field Structures

### Branch Links Configuration

```json
{
  "website": "https://branch.example.com",
  "facebook": "https://facebook.com/branchpage",
  "calendar": "https://calendar.google.com/...",
  "newsletter": "https://newsletter.example.com"
}
```

### Member Additional Information

```json
{
  "emergency_contact": {
    "name": "Jane Doe",
    "phone": "555-0123",
    "relationship": "spouse"
  },
  "dietary_restrictions": ["vegetarian", "nut allergy"],
  "interests": ["archery", "cooking", "music"],
  "awards_received": []
}
```

### Office Branch Type Constraints

```json
["Local", "College", "Household"]
```

### Award Specialties

```json
{
  "archery": ["target", "combat", "mounted"],
  "arts_sciences": ["cooking", "scribal", "clothing"],
  "service": ["event_steward", "officer", "teaching"]
}
```

## Database Design Principles

### 1. Referential Integrity

- All foreign key relationships properly constrained
- Cascade deletes for junction tables
- Soft deletes for entity tables to preserve history

### 2. Temporal Consistency

- ActiveWindow pattern ensures consistent temporal behavior
- Status fields automatically maintained based on dates
- Lifecycle transitions properly validated

### 3. Hierarchical Data

- Branch hierarchy using nested set model for efficient queries
- Self-referential relationships for office hierarchies
- Parent-child relationships for member management

### 4. Extensibility

- JSON fields for flexible configuration
- Polymorphic relationships for cross-cutting concerns
- Plugin-based schema extensions

### 5. Performance Optimization

- Comprehensive indexing strategy
- Efficient query patterns for common operations
- Caching integration for frequently accessed data

---

*These ER diagrams represent the complete KMP database schema as of the current version. For implementation details, refer to the Database Schema Documentation and Migration Documentation.*
