---
layout: default
---
[← Back to Services](6-services.md)

# 6.2 Authorization Helpers

**Last Updated:** November 4, 2025  
**Purpose:** Helper methods for authorization and permission management

## getBranchIdsForAction()

### Overview

A helper method in the `Member` entity that retrieves all branch IDs where a user has permission to perform a specific policy action. This is essential for populating dropdowns, autocomplete fields, and filtering queries to show only branches a user is authorized to work with.

### Method Signature

```php
public function getBranchIdsForAction(string $action, mixed $resource): ?array
```

**Location:** `src/Model/Entity/Member.php`

### Parameters

**`$action` (string):** The policy action/method name without the 'can' prefix
- Examples: `'edit'`, `'view'`, `'delete'`, `'add'`
- Automatically converts to policy method format (e.g., `'edit'` → `'canEdit'`)

**`$resource` (mixed):** The entity or table to check permissions for
- Can be a string table name: `'Members'`, `'Branches'`, `'Officers.Officers'`
- Can be an entity instance: `$membersTable->newEmptyEntity()`
- Can be a table instance: `$membersTable`

### Return Values

| Return Value | Meaning | Action |
|--------------|---------|--------|
| `null` | Global permission or super user | Load ALL branches |
| `[2, 11, 14, ...]` | Limited to specific branches | Load only these branches |
| `[]` (empty array) | No permission | Show error or hide UI |

### How It Works

1. **Super User Check:** Returns `null` immediately if user is a super user (bypass all restrictions)

2. **Resource Resolution:** Converts string table names or table instances to entity instances

3. **Policy Class Resolution:** Determines the correct policy class for the entity
   - `'Members'` → `App\Policy\MembersPolicy`
   - `'Officers.Officers'` → `Officers\Policy\OfficersPolicy`
   - Entity instances → Policy based on entity namespace

4. **Policy Method Conversion:** Converts action to policy method name
   - `'edit'` → `'canEdit'`
   - `'view'` → `'canView'`

5. **Permission Lookup:** Queries the user's policies for the specific policy class and method

6. **Scope Evaluation:** Returns appropriate value based on permission scoping rule
   - `Permission::SCOPE_GLOBAL` → Returns `null`
   - `Permission::SCOPE_BRANCH_ONLY` → Returns specific branch IDs
   - `Permission::SCOPE_BRANCH_AND_CHILDREN` → Returns branch IDs with hierarchy

### Helper Methods

#### `resolvePolicyClass(mixed $resource): ?string`

Protected helper that resolves the policy class name from a resource:
- Handles table instances
- Handles entity instances
- Handles plugin entities
- Returns fully qualified policy class name

#### `getPolicyClassFromTableName(string $tableName): string`

Protected helper that converts table names to policy class names:
- Handles plugin tables (e.g., `'Officers.Officers'`)
- Handles standard app tables (e.g., `'Members'`)

## Usage Examples

### Example 1: Basic Dropdown Population

```php
// In controller action
public function add()
{
    $member = $this->Members->newEmptyEntity();
    $user = $this->Authentication->getIdentity();
    
    // Get authorized branches
    $branchIds = $user->getBranchIdsForAction('add', 'Members');
    
    // Build branch list
    if ($branchIds === null) {
        // Global permission - all branches
        $branches = $this->fetchTable('Branches')
            ->find('list')
            ->orderBy(['name' => 'ASC'])
            ->all();
    } elseif (!empty($branchIds)) {
        // Limited permission - specific branches
        $branches = $this->fetchTable('Branches')
            ->find('list')
            ->where(['id IN' => $branchIds])
            ->orderBy(['name' => 'ASC'])
            ->all();
    } else {
        // No permission
        $branches = [];
        $this->Flash->error(__('You do not have permission to add members.'));
    }
    
    $this->set(compact('member', 'branches'));
}
```

### Example 2: Query Filtering

```php
// In controller index action
public function index()
{
    $user = $this->Authentication->getIdentity();
    $branchIds = $user->getBranchIdsForAction('view', 'Members');
    
    $query = $this->Members->find();
    
    // Apply branch filtering based on permissions
    if ($branchIds === null) {
        // No filtering needed - user can see all
    } elseif (!empty($branchIds)) {
        // Filter to authorized branches
        $query->where(['Members.branch_id IN' => $branchIds]);
    } else {
        // No access - return empty result
        $query->where(['1 = 0']);
    }
    
    $members = $this->paginate($query);
    $this->set(compact('members'));
}
```

### Example 3: AJAX Autocomplete Endpoint

```php
// In controller
public function autocomplete()
{
    $this->request->allowMethod(['get']);
    $user = $this->Authentication->getIdentity();
    
    // Get authorized branches
    $branchIds = $user->getBranchIdsForAction('edit', 'Members');
    
    $query = $this->fetchTable('Branches')->find();
    
    // Apply search term
    if ($term = $this->request->getQuery('term')) {
        $query->where(['name LIKE' => "%{$term}%"]);
    }
    
    // Apply authorization filter
    if ($branchIds === null) {
        // Global - no filter needed
    } elseif (!empty($branchIds)) {
        $query->where(['id IN' => $branchIds]);
    } else {
        // No access - empty result
        $query->where(['1 = 0']);
    }
    
    $branches = $query->limit(20)->all();
    
    $this->set(compact('branches'));
    $this->viewBuilder()->setOption('serialize', ['branches']);
}
```

### Example 4: Conditional Template Rendering

```php
// In template or element
<?php
$user = $this->getRequest()->getAttribute('identity');
$editBranches = $user->getBranchIdsForAction('edit', 'Members');
?>

<?php if ($editBranches !== []): ?>
    <?= $this->Form->control('branch_id', [
        'options' => $branches,  // Passed from controller
        'label' => __('Branch')
    ]); ?>
<?php else: ?>
    <p class="text-danger">
        <?= __('You do not have permission to edit members in any branch.') ?>
    </p>
<?php endif; ?>
```

### Example 5: Helper Method in Controller

Create a reusable helper method in `AppController` or specific controllers:

```php
/**
 * Get branches for a specific action, formatted for display
 *
 * @param string $action The action (edit, view, add, delete)
 * @param string $resource The resource table name
 * @return array List of branches or empty array
 */
protected function _getBranchesForAction(string $action, string $resource): array
{
    $user = $this->Authentication->getIdentity();
    $branchIds = $user->getBranchIdsForAction($action, $resource);
    
    $branchesTable = $this->fetchTable('Branches');
    
    if ($branchIds === null) {
        // Global permission
        return $branchesTable->find('list')
            ->orderBy(['name' => 'ASC'])
            ->all()
            ->toArray();
    }
    
    if (empty($branchIds)) {
        // No permission
        $this->Flash->error(__('You do not have permission for this action.'));
        return [];
    }
    
    // Limited permission
    return $branchesTable->find('list')
        ->where(['id IN' => $branchIds])
        ->orderBy(['name' => 'ASC'])
        ->all()
        ->toArray();
}

// Usage in action:
public function add()
{
    $branches = $this->_getBranchesForAction('add', 'Members');
    $this->set(compact('branches'));
}
```

### Example 6: Plugin Entities

```php
// Works with plugin entities
$user = $this->Authentication->getIdentity();

// Using string table name (plugin notation)
$branchIds = $user->getBranchIdsForAction('edit', 'Officers.Officers');

// Or using entity instance
$officer = $this->fetchTable('Officers.Officers')->newEmptyEntity();
$branchIds = $user->getBranchIdsForAction('edit', $officer);
```

### Example 7: Multiple Actions Check

```php
// Check multiple actions to determine UI state
public function edit($id)
{
    $member = $this->Members->get($id);
    $user = $this->Authentication->getIdentity();
    
    $canEdit = $user->getBranchIdsForAction('edit', 'Members');
    $canDelete = $user->getBranchIdsForAction('delete', 'Members');
    
    // Determine if current member's branch is in authorized list
    $canEditThis = ($canEdit === null) || in_array($member->branch_id, $canEdit ?? []);
    $canDeleteThis = ($canDelete === null) || in_array($member->branch_id, $canDelete ?? []);
    
    $this->set(compact('member', 'canEditThis', 'canDeleteThis'));
}
```

### Example 8: beforeRender in AppController

Make branch IDs available to all views:

```php
// In AppController
public function beforeRender(EventInterface $event)
{
    parent::beforeRender($event);
    
    if ($user = $this->Authentication->getIdentity()) {
        // Make common permission checks available to all views
        $viewBranches = $user->getBranchIdsForAction('view', 'Members');
        $editBranches = $user->getBranchIdsForAction('edit', 'Members');
        
        $this->set(compact('viewBranches', 'editBranches'));
    }
}
```

### Example 9: Service Layer Usage

```php
// In a service class
class MemberService
{
    public function getAuthorizedMembersForUser(Member $user): array
    {
        $branchIds = $user->getBranchIdsForAction('view', 'Members');
        
        $membersTable = TableRegistry::getTableLocator()->get('Members');
        $query = $membersTable->find();
        
        if ($branchIds === null) {
            // No filtering
        } elseif (!empty($branchIds)) {
            $query->where(['branch_id IN' => $branchIds]);
        } else {
            return []; // No permission
        }
        
        return $query->all()->toArray();
    }
}
```

## Quick Reference

### Common Action Names

| Action String | Policy Method | Common Use |
|---------------|---------------|------------|
| `'edit'` | `canEdit()` | Editing existing records |
| `'view'` | `canView()` | Viewing records |
| `'add'` | `canAdd()` | Creating new records |
| `'delete'` | `canDelete()` | Deleting records |
| `'index'` | `canIndex()` | Listing records |

### Resource Formats

```php
// String table name
$branchIds = $user->getBranchIdsForAction('edit', 'Members');

// Entity instance
$member = $membersTable->newEmptyEntity();
$branchIds = $user->getBranchIdsForAction('edit', $member);

// Plugin table (string notation)
$branchIds = $user->getBranchIdsForAction('edit', 'Officers.Officers');

// Table instance
$membersTable = $this->fetchTable('Members');
$branchIds = $user->getBranchIdsForAction('edit', $membersTable);
```

### Copy-Paste Template

```php
// Standard pattern for controller actions
public function myAction()
{
    $user = $this->Authentication->getIdentity();
    $branchIds = $user->getBranchIdsForAction('ACTION', 'TABLE_NAME');
    
    if ($branchIds === null) {
        // Global access - load all branches
        $branches = $this->fetchTable('Branches')->find('list')->all();
    } elseif (!empty($branchIds)) {
        // Limited access - load specific branches
        $branches = $this->fetchTable('Branches')
            ->find('list')
            ->where(['id IN' => $branchIds])
            ->all();
    } else {
        // No access
        $this->Flash->error('Permission denied');
        return $this->redirect(['action' => 'index']);
    }
    
    $this->set(compact('branches'));
}
```

## Integration with KMP Architecture

### Uses Existing Systems

1. **PermissionsLoader:** Leverages existing `getPolicies()` method
2. **Authorization Framework:** Integrates with CakePHP's authorization system
3. **Policy Classes:** Works with all existing policy classes (BasePolicy and subclasses)
4. **Scoping Rules:** Respects all permission scoping rules

### Compatible With

- All existing policy classes
- Plugin entities and policies
- Branch hierarchy system
- Role-based access control (RBAC)
- Warrant-based permissions

## Benefits

1. **UI Enhancement:** Populate dropdowns with only relevant branches
2. **Better UX:** Users don't see branches they can't access
3. **Security:** Enforces authorization at the UI level
4. **Consistency:** Works seamlessly with existing authorization system
5. **Flexibility:** Works with any entity and any action
6. **Performance:** Leverages existing caching in PermissionsLoader

## Troubleshooting

### Problem: Always getting empty array

**Check:**
1. User has appropriate role assignments
2. Role has permissions with policy mappings
3. Permission policies reference correct policy class and method
4. Branch assignments are set in `member_roles` table

### Problem: Getting null when expecting specific branches

**Check:**
1. User is not a super user
2. Permission scoping_rule is not set to `SCOPE_GLOBAL`

### Problem: Wrong branches returned

**Check:**
1. `branch_id` values in `member_roles` table
2. Permission `scoping_rule` (BRANCH_ONLY vs BRANCH_AND_CHILDREN)
3. Branch hierarchy if using BRANCH_AND_CHILDREN

### Problem: Plugin entities not working

**Check:**
1. Plugin policy class exists and follows naming convention
2. Plugin name matches exactly in table name (case-sensitive)
3. Policy class is in correct namespace (`PluginName\Policy\`)

## Best Practices

1. **Cache Results:** If calling multiple times with same parameters, cache the result
2. **Use in beforeRender:** Make common checks available to all views via `AppController::beforeRender()`
3. **Create Helper Methods:** Wrap common patterns in controller helper methods
4. **Check Empty vs Null:** Always distinguish between `[]` (no permission) and `null` (global)
5. **Order Matters:** Apply authorization filters AFTER other query conditions for better performance
6. **Test Both Cases:** Test with both global and limited permissions

## Future Enhancements

Potential improvements being considered:

1. **Caching:** Add method-level caching for repeated calls
2. **Method Overloads:** Create convenience methods for common entities
3. **Stimulus.js Integration:** Add JavaScript controller for dynamic branch filtering
4. **Table Helper:** Add helper method to `BranchesTable` for easier integration
5. **Permission Preview:** Add UI to show which branches a user can access for which actions

## Related Documentation

- **Authorization System:** [4.4 RBAC Security Architecture](4.4-rbac-security-architecture.md)
- **Policy Classes:** [4.4 RBAC Security Architecture](4.4-rbac-security-architecture.md)
- **Member Entity:** [Member.php](../app/src/Model/Entity/Member.php)
- **Services:** [6. Services](6-services.md)

---

[← Back to Services](6-services.md)
