# Timezone Handling in KMP

## Overview

The KMP application now provides comprehensive timezone support, allowing dates and times to be displayed in users' local timezones while storing everything in UTC in the database. This document explains the timezone system architecture and how to use it throughout the application.

## Architecture

### Storage
- **All dates and times are stored in UTC** in the database
- UTC storage prevents timezone-related bugs and ensures consistent data
- Timezone conversion happens only at display/input boundaries

### Display Priority
When displaying dates/times, the system resolves timezone in this order:

1. **Gathering's Timezone** - Event location timezone (`gatherings.timezone`) - used when displaying event-specific dates
2. **User's Timezone** - Individual member's timezone preference (`members.timezone`)
3. **Application Default** - System-wide default timezone (`KMP.DefaultTimezone` AppSetting)
4. **UTC Fallback** - Universal Coordinated Time (always available)

**Note:** The gathering timezone takes priority only when explicitly provided (e.g., when viewing a gathering's details or schedule). For general date displays without gathering context, the system uses the user's timezone.

### Components

#### PHP Components
- **`TimezoneHelper`** (`src/KMP/TimezoneHelper.php`) - Core timezone conversion logic
- **`TimezoneHelper` (View)** (`src/View/Helper/TimezoneHelper.php`) - Template-friendly wrapper
- **Migrations** - Adds `timezone` column to `members` and `gatherings` tables
- **Application Bootstrap** - Initializes `KMP.DefaultTimezone` AppSetting (default: America/Chicago) in `src/Application.php`

#### JavaScript Components
- **`timezone-utils.js`** (`assets/js/timezone-utils.js`) - Client-side timezone handling
- **Global `KMP_Timezone` object** - Available throughout the application

## Usage Guide

### PHP Usage

#### Basic Display in Controllers

```php
use App\KMP\TimezoneHelper;

// Get current user's timezone
$timezone = TimezoneHelper::getUserTimezone($this->Authentication->getIdentity());

// Convert UTC to user's timezone for display
$localTime = TimezoneHelper::toUserTimezone($gathering->start_date, $this->Authentication->getIdentity());

// Format for display with timezone
$displayTime = TimezoneHelper::formatForDisplay(
    $gathering->start_date,
    $this->Authentication->getIdentity(),
    'l, F j, Y g:i A T',  // Include timezone abbreviation
    true                   // Include timezone
);
// Output: "Saturday, March 15, 2025 9:00 AM CDT"
```

#### Form Input Conversion

```php
// When receiving form data (user's timezone -> UTC)
if ($this->request->is(['post', 'put'])) {
    $data = $this->request->getData();
    
    // Convert user's local time to UTC for storage
    $data['start_date'] = TimezoneHelper::toUtc(
        $data['start_date'],
        TimezoneHelper::getUserTimezone($this->Authentication->getIdentity())
    );
    
    $data['end_date'] = TimezoneHelper::toUtc(
        $data['end_date'],
        TimezoneHelper::getUserTimezone($this->Authentication->getIdentity())
    );
    
    $gathering = $this->Gatherings->patchEntity($gathering, $data);
    $this->Gatherings->save($gathering);
}
```

### Template Usage

#### Basic Display

```php
<!-- Display datetime in user's timezone -->
<?= $this->Timezone->format($gathering->start_date) ?>
<!-- Output: March 15, 2025 9:00 AM -->

<!-- Display datetime in gathering's timezone (event location) -->
<?= $this->Timezone->format($gathering->start_date, null, false, null, $gathering) ?>
<!-- Output: March 15, 2025 9:00 AM (in event's timezone) -->

<!-- With timezone abbreviation -->
<?= $this->Timezone->format($gathering->start_date, null, true) ?>
<!-- Output: March 15, 2025 9:00 AM CDT -->

<!-- Custom format -->
<?= $this->Timezone->format($gathering->start_date, 'l, F j, Y \a\t g:i A') ?>
<!-- Output: Saturday, March 15, 2025 at 9:00 AM -->
```

#### Date and Time Only

```php
<!-- Date only -->
<?= $this->Timezone->date($gathering->start_date) ?>
<!-- Output: March 15, 2025 -->

<!-- Time only -->
<?= $this->Timezone->time($gathering->start_date) ?>
<!-- Output: 9:00 AM -->

<!-- Custom date format -->
<?= $this->Timezone->date($gathering->start_date, 'M j, Y') ?>
<!-- Output: Mar 15, 2025 -->
```

#### Date Ranges

```php
<!-- Basic range -->
<?= $this->Timezone->range($gathering->start_date, $gathering->end_date) ?>
<!-- Output: March 15, 2025 9:00 AM - March 17, 2025 5:00 PM -->

<!-- Smart range (same day shows time range only) -->
<?= $this->Timezone->smartRange($activity->start_datetime, $activity->end_datetime) ?>
<!-- Same day: March 15, 2025 9:00 AM - 5:00 PM -->
<!-- Different days: March 15, 2025 - March 17, 2025 -->
```

#### Form Inputs

```php
<!-- datetime-local input with timezone conversion -->
<?= $this->Form->control('start_date', [
    'type' => 'datetime-local',
    'value' => $this->Timezone->forInput($gathering->start_date),
    'label' => 'Start Date/Time',
    'help' => 'Times are in your timezone: ' . $this->Timezone->getUserTimezone()
]) ?>

<!-- Show timezone notice to user -->
<?= $this->Timezone->notice('text-muted small mt-2') ?>
<!-- Output: <div class="text-muted small mt-2">
         <i class="bi bi-clock"></i> Times shown in America/Chicago (CDT)
     </div> -->
```

#### Timezone Selector

```php
<!-- Add timezone selector to member profile form -->
<?= $this->Form->control('timezone', [
    'type' => 'select',
    'options' => $this->Timezone->getTimezoneOptions(true), // common timezones only
    'empty' => '(Use Application Default)',
    'label' => 'Your Timezone',
    'help' => 'Select your timezone for personalized date/time display'
]) ?>

<!-- All timezones (for advanced users) -->
<?= $this->Form->control('timezone', [
    'type' => 'select',
    'options' => $this->Timezone->getTimezoneOptions(false), // all timezones
    'empty' => '(Use Application Default)'
]) ?>
```

### JavaScript Usage

#### Basic Formatting

```javascript
// Detect user's browser timezone
const userTz = KMP_Timezone.detectTimezone();
console.log(userTz); // "America/Chicago"

// Format UTC datetime for display
const utcString = "2025-03-15T14:30:00Z";
const displayed = KMP_Timezone.formatDateTime(utcString, "America/Chicago");
// "3/15/2025, 9:30:00 AM"

// Custom format
const formatted = KMP_Timezone.formatDateTime(utcString, "America/Chicago", {
    dateStyle: 'full',
    timeStyle: 'short'
});
// "Saturday, March 15, 2025 at 9:30 AM"
```

#### Form Input Handling

```javascript
// Convert UTC to local time for datetime-local input
const utcDate = "2025-03-15T14:30:00Z";
const inputValue = KMP_Timezone.toLocalInput(utcDate, "America/Chicago");
// "2025-03-15T09:30"

// Convert local datetime-local input to UTC for submission
const localInput = "2025-03-15T09:30";
const utcValue = KMP_Timezone.toUTC(localInput, "America/Chicago");
// "2025-03-15T14:30:00.000Z"
```

#### Auto-Converting Forms

```html
<!-- HTML: datetime-local input with data attributes -->
<input type="datetime-local" 
       name="start_date"
       data-timezone="America/Chicago"
       data-utc-value="2025-03-15T14:30:00Z">

<script>
// JavaScript: Auto-initialize on page load (already done in timezone-utils.js)
// Finds all inputs with data-utc-value and converts them to local time
KMP_Timezone.initializeDatetimeInputs();

// Or for a specific container
const modal = document.getElementById('myModal');
KMP_Timezone.initializeDatetimeInputs(modal);
</script>
```

#### Form Submission Conversion

```javascript
// Attach to form submit to auto-convert all datetime-local inputs to UTC
document.getElementById('myForm').addEventListener('submit', function(e) {
    const form = e.target;
    const timezone = KMP_Timezone.detectTimezone();
    
    // This will convert all datetime-local inputs to UTC
    // and create hidden inputs with the UTC values
    KMP_Timezone.convertFormDatetimesToUTC(form, timezone);
});
```

## Configuration

### Setting User Timezone

Users can set their timezone in their member profile:

```php
// In MembersController::edit()
$member->timezone = 'America/New_York';
$this->Members->save($member);
```

### Setting Application Default

Administrators can change the application default timezone through AppSettings:

1. Navigate to App Settings management
2. Find `KMP.DefaultTimezone`
3. Set to desired IANA timezone identifier (e.g., `America/New_York`, `UTC`)

Or programmatically:

```php
use App\KMP\StaticHelpers;

StaticHelpers::setAppSetting('KMP.DefaultTimezone', 'America/New_York');
```

### Common Timezones

The system provides shortcuts for common US timezones:

- `America/Chicago` - Central Time (US)
- `America/New_York` - Eastern Time (US)
- `America/Denver` - Mountain Time (US)
- `America/Los_Angeles` - Pacific Time (US)
- `America/Phoenix` - Arizona (MST - No DST)
- `America/Anchorage` - Alaska Time (US)
- `Pacific/Honolulu` - Hawaii Time (US)
- `UTC` - Coordinated Universal Time

## Migration and Deployment

### Running the Migration

```bash
cd /workspaces/KMP/app
bin/cake migrations migrate
```

This will add the `timezone` column to the `members` table.

### Running the Seed

```bash
cd /workspaces/KMP/app
bin/cake migrations seed --seed DefaultTimezoneSeed
```

This will create the `KMP.DefaultTimezone` AppSetting.

### Asset Compilation

After pulling timezone changes, recompile assets:

```bash
cd /workspaces/KMP/app
npm run dev    # Development
npm run prod   # Production
```

## Implementation Checklist

When implementing timezone support in a new feature:

### For Display

- [ ] Use `TimezoneHelper::toUserTimezone()` or `$this->Timezone->format()` for all datetime display
- [ ] Consider using `$this->Timezone->smartRange()` for date ranges
- [ ] Add timezone notice with `$this->Timezone->notice()` where helpful
- [ ] Pass current user/identity to timezone helpers

### For Form Input

- [ ] Use `$this->Timezone->forInput()` to populate datetime-local inputs
- [ ] Add timezone context help text to form fields
- [ ] Convert user input back to UTC using `TimezoneHelper::toUtc()` before saving
- [ ] Validate timezone values if allowing user to set timezone

### For JavaScript

- [ ] Use `data-utc-value` attribute for inputs that should auto-convert
- [ ] Call `KMP_Timezone.initializeDatetimeInputs()` after dynamic content loads
- [ ] Use `KMP_Timezone.formatDateTime()` for client-side datetime display
- [ ] Attach `KMP_Timezone.convertFormDatetimesToUTC()` to form submit events

## Examples from KMP

### Gatherings Calendar

```php
// Controller
$gathering = $this->Gatherings->get($id);
$this->set('gathering', $gathering);

// Template
<h1><?= h($gathering->name) ?></h1>
<p>
    <strong>When:</strong> 
    <?= $this->Timezone->smartRange($gathering->start_date, $gathering->end_date) ?>
    <?= $this->Timezone->notice() ?>
</p>
```

### Gathering Schedule Activities

```php
// Controller - when saving
$data = $this->request->getData();
$data['start_datetime'] = TimezoneHelper::toUtc(
    $data['start_datetime'],
    TimezoneHelper::getUserTimezone($this->Authentication->getIdentity())
);

// Template - when editing
<?= $this->Form->control('start_datetime', [
    'type' => 'datetime-local',
    'value' => $this->Timezone->forInput($activity->start_datetime),
    'min' => $this->Timezone->forInput($gathering->start_date),
    'max' => $this->Timezone->forInput($gathering->end_date)
]) ?>
```

### Member Profile

```php
// Add timezone selector to member edit form
<?= $this->Form->control('timezone', [
    'type' => 'select',
    'options' => $this->Timezone->getTimezoneOptions(),
    'empty' => sprintf('(Use Application Default: %s)', 
        \App\KMP\TimezoneHelper::getAppTimezone() ?? 'UTC'),
    'label' => 'Your Timezone',
    'help' => 'Select your timezone to see dates and times in your local time'
]) ?>
```

### Gathering Timezone (Event Location)

Gatherings can have their own timezone based on the event location. This ensures that event times are always displayed consistently in the event's local time, regardless of where users are viewing from.

#### Setting Gathering Timezone

```php
// In gathering add/edit form
<?= $this->Form->control('timezone', [
    'type' => 'select',
    'options' => $this->Timezone->getTimezoneOptions(),
    'empty' => '(Use event timezone from location)',
    'label' => 'Event Timezone',
    'help' => 'Set the timezone for this event based on its location. If not set, times will display in each user\'s timezone.'
]) ?>
```

#### Displaying Event Times in Event Timezone

```php
// In gathering view - display times in event's timezone
<h3><?= h($gathering->name) ?></h3>
<p>
    <strong>When:</strong>
    <?= $this->Timezone->format($gathering->start_date, 'l, F j, Y g:i A T', true, null, $gathering) ?>
    to
    <?= $this->Timezone->format($gathering->end_date, 'l, F j, Y g:i A T', true, null, $gathering) ?>
</p>

<!-- Note: Passing $gathering as the 5th parameter ensures times display in event timezone -->
```

#### Scheduled Activities with Gathering Timezone

```php
// In schedule display - activities inherit gathering timezone
<?php foreach ($gathering->gathering_scheduled_activities as $activity): ?>
    <div class="activity">
        <strong><?= h($activity->name) ?></strong><br>
        <?= $this->Timezone->format($activity->start_datetime, 'g:i A', false, null, $gathering) ?>
        <?php if ($activity->has_end_time): ?>
            - <?= $this->Timezone->time($activity->end_datetime, null, null, $gathering) ?>
        <?php endif; ?>
    </div>
<?php endforeach; ?>
```

#### Controller: Converting with Gathering Timezone

```php
// When saving gathering schedule, use gathering's timezone for input conversion
if ($this->request->is(['post', 'put'])) {
    $data = $this->request->getData();
    
    // Get the timezone to use (gathering's or user's)
    $timezone = TimezoneHelper::getGatheringTimezone($gathering, $this->Authentication->getIdentity());
    
    // Convert from gathering timezone to UTC
    $data['start_datetime'] = TimezoneHelper::toUtc($data['start_datetime'], $timezone);
    $data['end_datetime'] = TimezoneHelper::toUtc($data['end_datetime'], $timezone);
    
    $activity = $this->GatheringScheduledActivities->patchEntity($activity, $data);
    $this->GatheringScheduledActivities->save($activity);
}
```

## Testing

### Manual Testing

1. **Set user timezone**: Edit member profile, set timezone to different value
2. **Verify display**: Check that datetimes show in user's timezone
3. **Verify input**: Create/edit records with datetime fields
4. **Verify storage**: Check database - should still be UTC
5. **Verify conversion**: User in Chicago sees 9:00 AM, user in New York sees 10:00 AM (same UTC time)

### Automated Testing

```php
// Test timezone conversion
public function testTimezoneConversion()
{
    $member = $this->Members->newEntity(['timezone' => 'America/Chicago']);
    
    $utcDate = new DateTime('2025-03-15 14:30:00', new DateTimeZone('UTC'));
    $localDate = TimezoneHelper::toUserTimezone($utcDate, $member);
    
    $this->assertEquals('2025-03-15 09:30:00', $localDate->format('Y-m-d H:i:s'));
}
```

## Troubleshooting

### Dates showing in UTC instead of local time

- Check that `timezone` field is populated (user timezone)
- Check that `KMP.DefaultTimezone` AppSetting exists
- Ensure using `$this->Timezone->format()` or `TimezoneHelper::toUserTimezone()`
- Clear cache: `bin/cake cache clear_all`

### Form submissions saving wrong time

- Ensure converting input to UTC before saving with `TimezoneHelper::toUtc()`
- Check that timezone is being passed to conversion function
- Verify datetime-local input format is correct (YYYY-MM-DDTHH:mm)

### Invalid timezone error

- Ensure timezone value is valid IANA identifier
- Use `TimezoneHelper::isValidTimezone()` to validate
- Check against `TimezoneHelper::getCommonTimezones()` or `getTimezoneList()`

### JavaScript not converting times

- Check browser console for errors
- Ensure `timezone-utils.js` is loaded
- Verify `KMP_Timezone` object is available globally
- Check that `data-utc-value` attribute is set correctly

## Best Practices

1. **Always store in UTC** - Never store local times in database
2. **Convert at boundaries** - Convert to/from UTC only at display/input points
3. **Pass user context** - Always pass current user to timezone helpers
4. **Provide feedback** - Show user which timezone is being used
5. **Handle nulls** - Allow null/empty timezones (use app default)
6. **Validate inputs** - Validate timezone identifiers before saving
7. **Test edge cases** - Test DST transitions, midnight times, date boundaries
8. **Document usage** - Note timezone handling in code comments

## Future Enhancements

Potential improvements for the timezone system:

- **Session caching**: Cache user timezone in session to reduce database queries
- **Auto-detect on signup**: Offer to use browser-detected timezone for new users
- **Timezone by branch**: Allow branches to have default timezones
- **Multiple timezone display**: Show event times in multiple timezones
- **Timezone warnings**: Warn when event timezone differs from user timezone
- **Historical timezone**: Handle timezone changes for past events

## Resources

- [PHP Timezones](https://www.php.net/manual/en/timezones.php) - List of all IANA timezone identifiers
- [DateTimeZone](https://www.php.net/manual/en/class.datetimezone.php) - PHP DateTimeZone class
- [Intl.DateTimeFormat](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl/DateTimeFormat) - JavaScript datetime formatting
- [CakePHP DateTime](https://book.cakephp.org/4/en/core-libraries/time.html) - CakePHP DateTime utilities
