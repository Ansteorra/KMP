---
layout: default
---
[← Back to JavaScript Development](10-javascript-development.md) | [← Back to Table of Contents](index.md)

# 10.4 Asset Management

**Last Updated:** December 3, 2025

This document explains how KMP manages, compiles, and serves static assets (CSS, JavaScript, images, fonts).

## Overview

KMP uses Laravel Mix for asset compilation and versioning. Assets are developed in `assets/` and compiled to `webroot/` for production use. This approach provides:

- **Source asset organization**: ES6+ JavaScript, SCSS preprocessing
- **Asset minification**: Reduced file sizes for faster loading
- **Asset versioning**: Automatic cache busting via file hashing
- **Development watch mode**: Automatic recompilation on file changes
- **Bootstrap integration**: Bundled with Bootstrap CSS framework
- **Stimulus.JS integration**: Controller framework for interactivity

## Directory Structure

### Source Assets (Development)

```
assets/
├── css/
│   ├── app.css              # Main application styles
│   └── [custom-styles].css  # Additional stylesheets
├── js/
│   ├── index.js             # Application entry point
│   ├── KMP_utils.js         # Shared utility functions
│   └── controllers/         # Stimulus.JS controllers
│       ├── [name]-controller.js
│       └── [feature]-controller.js
└── images/                  # Source images (if any)
```

### Public Assets (Production)

```
webroot/
├── css/
│   ├── app.css              # Compiled CSS
│   ├── app.css.map          # Source map for debugging
│   ├── manifest.json        # Asset manifest (versioning)
│   └── app-[hash].css       # Versioned production build
├── js/
│   ├── app.js               # Compiled JavaScript
│   ├── app.js.map           # Source map for debugging
│   ├── manifest.json        # Asset manifest
│   ├── app-[hash].js        # Versioned production build
│   └── vendor-[hash].js     # Extracted vendor dependencies
├── assets/
│   ├── bootstrap-icons/     # Bootstrap Icons (JSON and font files)
│   └── [other-assets]/
└── img/                     # Images and logos
```

## Asset Compilation

### Laravel Mix Configuration

Asset compilation is configured in `webpack.mix.js`:

```javascript
// webpack.mix.js
const mix = require('laravel-mix');

mix.js('assets/js/index.js', 'webroot/js')
   .css('assets/css/app.css', 'webroot/css')
   .extract(['bootstrap', 'popper.js', '@hotwired/turbo', '@hotwired/stimulus'])
   .version();
```

**Configuration Options:**

| Option | Purpose |
|--------|---------|
| `mix.js()` | Compile JavaScript files |
| `mix.css()` | Process CSS files |
| `mix.extract()` | Extract vendor libraries to separate bundle |
| `mix.version()` | Add content hash to filenames |
| `mix.map()` | Generate source maps for debugging |

### Compilation Process

#### Development Build

Uncompressed assets with source maps:

```bash
npm run dev
```

Creates:
- `webroot/js/app.js` (uncompressed)
- `webroot/js/app.js.map` (source map)
- `webroot/css/app.css` (uncompressed)
- `webroot/css/app.css.map` (source map)

#### Watch Mode (Development)

Automatically recompile on file changes:

```bash
npm run watch
```

Useful during development for immediate feedback on changes.

#### Production Build

Minified assets with versioning:

```bash
npm run prod
```

Creates:
- `webroot/js/app-abc123.js` (minified, hashed)
- `webroot/js/vendor-def456.js` (extracted dependencies)
- `webroot/css/app-xyz789.css` (minified, hashed)
- `webroot/mix-manifest.json` (mapping for version helpers)

### Asset Versioning

Asset versioning prevents browser caching issues by adding content hashes to filenames:

```
app.js                    → app-abc123def456.js
app.css                   → app-xyz789ghi012.js
vendor.js                 → vendor-jkl345mno678.js
```

When file contents change, the hash changes, forcing browsers to download the new version.

#### Using Versioned Assets in Templates

```php
<!-- In CakePHP templates -->
<?= $this->Html->script('app'); ?>           <!-- Uses versioned filename -->
<?= $this->Html->css('app'); ?>              <!-- Uses versioned filename -->
<?= $this->Html->image('badge.png'); ?>      <!-- Static images -->

<!-- Correct output (with hash) -->
<script src="/js/app-abc123.js"></script>
<link rel="stylesheet" href="/css/app-xyz789.css">
```

The `Html` helper automatically maps asset names to versioned filenames using `mix-manifest.json`.

## JavaScript Assets

### Entry Point: index.js

The main application entry point (`assets/js/index.js`) initializes all JavaScript:

```javascript
// assets/js/index.js

// 1. Import Bootstrap JavaScript
import 'bootstrap';

// 2. Import HTTP client
import * as Turbo from "@hotwired/turbo";

// 3. Import Stimulus.JS framework
import { Application } from "@hotwired/stimulus";

// 4. Import utility functions
import KMP_utils from './KMP_utils.js';

// 5. Initialize Stimulus application
window.Stimulus = Application.start();

// 6. Make utilities available globally
window.KMP_utils = KMP_utils;

// 7. Auto-register all Stimulus controllers
for (var controller in window.Controllers) {
    Stimulus.register(controller, window.Controllers[controller]);
}
```

### Stimulus.JS Controllers

Controllers are stored in `assets/js/controllers/` with `-controller.js` suffix:

```
assets/js/controllers/
├── form-validation-controller.js
├── modal-controller.js
├── datetime-picker-controller.js
└── [feature]-controller.js
```

#### Controller Structure

```javascript
// assets/js/controllers/my-feature-controller.js
import { Controller } from "@hotwired/stimulus";

class MyFeatureController extends Controller {
    // Define target elements
    static targets = ["input", "output", "button"];
    
    // Define dynamic values
    static values = {
        url: String,
        delay: { type: Number, default: 300 }
    };
    
    // Define outlet connections
    static outlets = ["other-controller"];
    
    // Initialize (optional)
    initialize() {
        // Setup code
    }
    
    // Connect - runs when controller connects
    connect() {
        console.log("Controller connected");
    }
    
    // Event handlers
    handleClick(event) {
        // Handle button click
    }
    
    // Disconnect - cleanup
    disconnect() {
        // Cleanup code
    }
}

// Register in global registry
if (!window.Controllers) {
    window.Controllers = {};
}
window.Controllers["my-feature"] = MyFeatureController;
```

#### HTML Integration

```html
<!-- Use controller with data attributes -->
<div data-controller="my-feature" 
     data-my-feature-url-value="/api/endpoint">
  <input data-my-feature-target="input">
  <div data-my-feature-target="output"></div>
  <button data-my-feature-target="button" 
          data-action="click->my-feature#handleClick">
    Click Me
  </button>
</div>
```

### Utility Functions

Shared utility functions in `assets/js/KMP_utils.js`:

```javascript
// assets/js/KMP_utils.js
export default {
    /**
     * Get URL parameter by name
     * @param {string} name - Parameter name
     * @returns {string|null} Parameter value or null
     */
    urlParam(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
    },
    
    /**
     * Sanitize HTML string to prevent XSS
     * @param {string} str - String to sanitize
     * @returns {string} Sanitized string
     */
    sanitizeString(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    },
    
    // ... additional utilities
};
```

Access globally:

```javascript
// In any controller or JavaScript
window.KMP_utils.urlParam('search');
window.KMP_utils.sanitizeString(userInput);
```

## CSS Assets

### Main Stylesheet

The main application stylesheet (`assets/css/app.css`) includes:

```css
/* assets/css/app.css */

/* 1. Bootstrap custom variables */
$primary: #007bff;
$secondary: #6c757d;

/* 2. Import Bootstrap */
@import 'node_modules/bootstrap/scss/bootstrap';

/* 3. Application-specific styles */
@import 'components/buttons';
@import 'components/cards';
@import 'layouts/navbar';
@import 'layouts/footer';
@import 'pages/member-list';
@import 'pages/dashboard';
```

### Plugin Stylesheets

Plugin-specific styles are managed in each plugin:

```
plugins/PluginName/
├── assets/
│   └── css/
│       └── plugin-styles.css
└── webroot/
    └── css/
        └── plugin-styles.css  (compiled output)
```

### CSS Organization Best Practices

1. **Components**: Reusable UI elements
   ```css
   assets/css/components/buttons.css
   assets/css/components/cards.css
   assets/css/components/forms.css
   ```

2. **Layouts**: Page structure styles
   ```css
   assets/css/layouts/navbar.css
   assets/css/layouts/sidebar.css
   assets/css/layouts/footer.css
   ```

3. **Pages**: Page-specific overrides
   ```css
   assets/css/pages/member-list.css
   assets/css/pages/dashboard.css
   ```

4. **Utilities**: Utility/helper classes
   ```css
   assets/css/utilities/spacing.css
   assets/css/utilities/typography.css
   ```

## Image Assets

### Image Organization

```
webroot/img/
├── badge.png               # Application logo
├── icons/                  # Custom icons
├── backgrounds/            # Background images
└── members/                # Member photos (if applicable)
```

### Using Images in Templates

```php
<!-- In CakePHP templates -->
<?= $this->Html->image('badge.png', ['alt' => 'KMP Logo']) ?>
<?= $this->Html->image('icons/star.svg', ['class' => 'icon']) ?>
```

### Bootstrap Icons

Bootstrap Icons are pre-included in the application:

```
webroot/assets/bootstrap-icons/
├── font/
│   ├── bootstrap-icons.json
│   ├── bootstrap-icons.woff
│   └── bootstrap-icons.woff2
└── svg/
    └── [icon-name].svg
```

#### Using Bootstrap Icons

In templates:

```php
<?= $this->Icon->render('star-fill', ['set' => 'bs']) ?>
<?= $this->Icon->render('person-fill', ['set' => 'bs', 'class' => 'text-primary']) ?>
```

## Asset Pipeline Configuration

### Webpack.mix.js

The complete Laravel Mix configuration:

```javascript
const mix = require('laravel-mix');

// Configure Laravel Mix
mix
    // Compile main application JavaScript
    .js('assets/js/index.js', 'webroot/js')
    
    // Process main application CSS
    .css('assets/css/app.css', 'webroot/css')
    
    // Extract vendor libraries to separate file
    .extract([
        'bootstrap',
        'popper.js',
        '@hotwired/turbo',
        '@hotwired/stimulus'
    ])
    
    // Enable source maps for development
    .sourceMaps()
    
    // Add versioning/cache busting for production
    .version();

// Development-only configurations
if (mix.inProduction()) {
    // Production optimizations
    mix.minify('webroot/js/app.js');
    mix.minify('webroot/css/app.css');
} else {
    // Development features
    mix.disableSuccessNotifications();
}
```

### NPM Scripts

Defined in `package.json`:

```json
{
    "scripts": {
        "dev": "mix",
        "watch": "mix watch",
        "prod": "mix --production",
        "test": "jest",
        "test:ui": "playwright test",
        "lint": "eslint assets/js --fix"
    }
}
```

## Performance Optimization

### Asset Minification

Automatically enabled in production (`npm run prod`):

- JavaScript minified and obfuscated
- CSS whitespace removed
- Comments stripped
- Variable names shortened

### Asset Extraction

Vendor libraries extracted to separate files:

- `app.js` - Application code only
- `vendor.js` - External dependencies (Bootstrap, Stimulus, etc.)

Benefits:
- Vendor code cached separately
- Application code updates don't invalidate vendor cache
- Parallel download of assets

### Gzip Compression

For best performance, enable gzip on web server:

**Apache (.htaccess):**
```apache
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml
    AddOutputFilterByType DEFLATE text/css text/javascript
    AddOutputFilterByType DEFLATE application/javascript
</IfModule>
```

**Nginx (config):**
```nginx
gzip on;
gzip_types text/plain text/css text/xml text/javascript
           application/x-javascript application/xml+rss
           application/javascript image/svg+xml;
```

### Cache Headers

Set long-term cache headers for versioned assets:

**Apache (.htaccess):**
```apache
<FilesMatch "\-[0-9a-f]{8}\.(js|css)$">
    Header set Cache-Control "max-age=31536000, public"
</FilesMatch>
```

**Nginx:**
```nginx
location ~* ^/.*\-[0-9a-f]{8}\.(js|css)$ {
    expires 1y;
}
```

## Development Workflow

### Starting Watch Mode

During development, run watch mode to auto-compile:

```bash
npm run watch
```

This will:
- Watch `assets/` for changes
- Auto-compile JavaScript and CSS
- Display compilation status
- Reload browser (if using BrowserSync, optional)

### Development vs. Production

| Activity | Command | Output | Use Case |
|----------|---------|--------|----------|
| Active development | `npm run watch` | Unminified, source maps | Local development |
| One-time compile | `npm run dev` | Unminified, source maps | CI/CD before testing |
| Production build | `npm run prod` | Minified, versioned | Deployment to production |

### Debugging

With source maps enabled, debug original source files in browser DevTools:

```javascript
// Source file (assets/js/controllers/form-controller.js)
handleSubmit(event) {
    console.log("Form submitted");  // ← Click to go to source
}
```

DevTools shows original file locations, not compiled output.

## Asset Integration with CakePHP

### Html Helper

Use CakePHP's Html helper for asset linking:

```php
<!-- Script tags -->
<?= $this->Html->script('app') ?>
<?= $this->Html->script(['app', 'widgets']) ?>

<!-- Stylesheet links -->
<?= $this->Html->css('app') ?>
<?= $this->Html->css(['bootstrap', 'app']) ?>

<!-- Images -->
<?= $this->Html->image('logo.png') ?>
<?= $this->Html->image('icons/star.svg', ['class' => 'icon']) ?>
```

### Asset Helper

Custom asset path helper:

```php
<?= $this->Html->url('/js/app.js') ?>
<?= $this->Html->url(Router::url(['_name' => 'images', 'logo.png'], true)) ?>
```

## Troubleshooting

### Assets Not Loading

1. **Verify assets compiled**: Run `npm run dev`
2. **Check file permissions**: Ensure webroot is readable
3. **Clear browser cache**: Force refresh (Ctrl+F5 or Cmd+Shift+R)
4. **Check web server config**: Verify static file serving is enabled

### Changes Not Reflecting

1. **Stop watch mode**: Press Ctrl+C in terminal
2. **Recompile**: Run `npm run dev` or `npm run watch`
3. **Clear cache**: Browser cache might be stale

### Module Not Found Errors

1. **Install dependencies**: Run `npm install`
2. **Verify import paths**: Check file names and locations
3. **Check node_modules**: Ensure dependencies were installed

### Source Maps Not Working

1. **Check build type**: Ensure not using `npm run prod`
2. **Enable in DevTools**: Settings → Sources → Enable JavaScript source maps
3. **Rebuild**: Run `npm run dev` with clean build

## See Also

- [JavaScript Development](10-javascript-development.md)
- [Bootstrap Icons Configuration](9.2-bootstrap-icons.md)
- [Stimulus.JS Framework](10.1-javascript-framework.md)
- [Laravel Mix Documentation](https://laravel-mix.com/docs)
