---
layout: default
---
[← Back to JavaScript Development](10-javascript-development.md)

# QR Code Controller

**Last Updated:** November 4, 2025  
**Status:** Active  
**Controller:** `qrcode-controller.js`  
**NPM Package:** `qrcode`

## Overview

The QR Code Stimulus controller provides reusable QR code generation functionality using the npm-managed `qrcode` package. It replaces inline scripts with CDN dependencies, providing better security, performance, and maintainability.

## Features

- **Reusable:** Single controller handles all QR code needs across the application
- **NPM-Managed:** Uses `qrcode` package instead of CDN dependencies
- **Lazy Loading:** Generates QR codes only when needed (e.g., when modal is shown)
- **Modal Integration:** Automatically detects Bootstrap modals and defers generation
- **Customizable:** Configurable size, colors, and error correction level
- **User Actions:** Download as PNG and copy to clipboard
- **CSP Compliant:** No inline scripts, all code in bundled assets

## Installation

The `qrcode` package is included in `package.json`:

```bash
cd app
npm install
```

This installs the `qrcode` package (version ~1.5.x) along with its dependencies.

## Controller Structure

### Location

**File:** `app/assets/js/controllers/qrcode-controller.js`

### Static Targets

```javascript
static targets = ["canvas"]
```

- `canvas`: The canvas element where the QR code is rendered

### Static Values

```javascript
static values = {
    url: String,                    // URL to encode in QR code
    size: { type: Number, default: 256 },  // Canvas size in pixels
    modalId: String,                // Optional modal ID for lazy loading
    colorDark: { type: String, default: "#000000" },     // QR code dark color
    colorLight: { type: String, default: "#ffffff" },    // QR code light color
    errorCorrectionLevel: { type: String, default: "M" } // L, M, Q, or H
}
```

### Methods

#### connect()

Called when controller connects to DOM. Detects if canvas is in a modal and sets up event listeners for lazy loading.

```javascript
connect() {
    if (this.hasModalIdValue) {
        // Setup lazy loading via modal event
        this.setupModalListener();
    } else {
        // Generate immediately if not in modal
        this.generate();
    }
}
```

#### generate()

Generates the QR code on the canvas element.

```javascript
generate() {
    if (!this.hasUrlValue || !this.hasCanvasTarget) {
        console.error('QR Code: Missing required url or canvas target');
        return;
    }

    const options = {
        width: this.sizeValue,
        color: {
            dark: this.colorDarkValue,
            light: this.colorLightValue
        },
        errorCorrectionLevel: this.errorCorrectionLevelValue
    };

    QRCode.toCanvas(this.canvasTarget, this.urlValue, options, (error) => {
        if (error) {
            console.error('QR Code generation failed:', error);
        }
    });
}
```

#### download()

Downloads the QR code as a PNG image file.

```javascript
download(event) {
    event.preventDefault();
    
    this.canvasTarget.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.download = 'qrcode.png';
        link.href = url;
        link.click();
        URL.revokeObjectURL(url);
    });
}
```

#### copyToClipboard()

Copies the QR code image to clipboard.

```javascript
async copyToClipboard(event) {
    event.preventDefault();
    
    try {
        this.canvasTarget.toBlob(async (blob) => {
            await navigator.clipboard.write([
                new ClipboardItem({ 'image/png': blob })
            ]);
            alert('QR code copied to clipboard!');
        });
    } catch (error) {
        console.error('Failed to copy QR code:', error);
        alert('Failed to copy QR code to clipboard');
    }
}
```

#### regenerate()

Manually triggers QR code regeneration. Useful if URL changes dynamically.

```javascript
regenerate(event) {
    if (event) event.preventDefault();
    this.generate();
}
```

## Usage Examples

### Basic Usage

Generate QR code immediately on page load:

```html
<div data-controller="qrcode"
     data-qrcode-url-value="https://example.com/event/123">
    <canvas data-qrcode-target="canvas"></canvas>
</div>
```

### With Custom Size and Colors

```html
<div data-controller="qrcode"
     data-qrcode-url-value="https://example.com/event/123"
     data-qrcode-size-value="300"
     data-qrcode-color-dark-value="#1a5490"
     data-qrcode-color-light-value="#f0f0f0">
    <canvas data-qrcode-target="canvas"></canvas>
</div>
```

### Lazy Loading in Modal

QR code generation is deferred until modal is shown:

```html
<!-- Modal trigger -->
<button type="button" data-bs-toggle="modal" data-bs-target="#qrModal">
    Show QR Code
</button>

<!-- Modal -->
<div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Event QR Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center"
                 data-controller="qrcode"
                 data-qrcode-url-value="https://example.com/event/123"
                 data-qrcode-modal-id-value="qrModal">
                <canvas data-qrcode-target="canvas"></canvas>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary"
                        data-action="click->qrcode#download">
                    <i class="bi bi-download"></i> Download
                </button>
                <button type="button" class="btn btn-secondary"
                        data-action="click->qrcode#copyToClipboard">
                    <i class="bi bi-clipboard"></i> Copy
                </button>
            </div>
        </div>
    </div>
</div>
```

### With Download and Copy Actions

```html
<div data-controller="qrcode"
     data-qrcode-url-value="https://example.com/event/123">
    <canvas data-qrcode-target="canvas"></canvas>
    
    <div class="mt-3">
        <button class="btn btn-sm btn-primary"
                data-action="click->qrcode#download">
            <i class="bi bi-download"></i> Download PNG
        </button>
        
        <button class="btn btn-sm btn-secondary"
                data-action="click->qrcode#copyToClipboard">
            <i class="bi bi-clipboard"></i> Copy to Clipboard
        </button>
    </div>
</div>
```

### Error Correction Levels

Higher error correction allows QR code to be read even if partially damaged:

- **L (Low):** ~7% damage tolerance
- **M (Medium):** ~15% damage tolerance (default)
- **Q (Quartile):** ~25% damage tolerance
- **H (High):** ~30% damage tolerance

```html
<div data-controller="qrcode"
     data-qrcode-url-value="https://example.com/event/123"
     data-qrcode-error-correction-level-value="H">
    <canvas data-qrcode-target="canvas"></canvas>
</div>
```

## Integration with Gathering Public Pages

The QR code controller is used on gathering public landing pages to provide easy sharing:

**Template:** `templates/Gatherings/public_landing.php`

```php
<div class="text-center mb-4">
    <button type="button" 
            class="btn btn-outline-light" 
            data-bs-toggle="modal" 
            data-bs-target="#qrCodeModal">
        <i class="bi bi-qr-code"></i> <?= __('View QR Code') ?>
    </button>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrCodeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><?= __('Share Event') ?></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center"
                 data-controller="qrcode"
                 data-qrcode-url-value="<?= $this->Url->build([
                     'controller' => 'Gatherings',
                     'action' => 'publicLanding',
                     $gathering->public_id
                 ], ['fullBase' => true]) ?>"
                 data-qrcode-size-value="300"
                 data-qrcode-modal-id-value="qrCodeModal">
                <canvas data-qrcode-target="canvas" class="mx-auto"></canvas>
                <p class="mt-3 small text-muted">
                    <?= __('Scan to view event details') ?>
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary"
                        data-action="click->qrcode#download">
                    <i class="bi bi-download"></i> <?= __('Download') ?>
                </button>
                <button type="button" class="btn btn-secondary"
                        data-action="click->qrcode#copyToClipboard">
                    <i class="bi bi-clipboard"></i> <?= __('Copy') ?>
                </button>
            </div>
        </div>
    </div>
</div>
```

## Controller Registration

The QR code controller is registered in the global Stimulus application via `index.js`:

**File:** `app/assets/js/index.js`

```javascript
import QRCodeController from './controllers/qrcode-controller.js';

// Register controller
if (!window.Controllers) {
    window.Controllers = {};
}
window.Controllers["qrcode"] = QRCodeController;

// Later in file, after Stimulus is initialized
for (var controller in window.Controllers) {
    window.Stimulus.register(controller, window.Controllers[controller]);
}
```

## Benefits of Refactored Approach

### Security

**Before (CDN):**
- External dependency on CDN
- CSP complications with external scripts
- Version pinning challenges
- Potential for CDN compromise

**After (NPM):**
- ✅ All code bundled in application assets
- ✅ CSP compliant (no external scripts)
- ✅ Version locked in package.json
- ✅ Reviewed and audited dependencies

### Performance

**Before:**
- Extra HTTP request to CDN
- Dependent on CDN availability
- No control over caching

**After:**
- ✅ Single bundled asset file
- ✅ Controlled caching strategy
- ✅ Offline capability

### Maintainability

**Before:**
- Inline scripts scattered across templates
- Code duplication
- Hard to test
- Version inconsistencies

**After:**
- ✅ Single reusable controller
- ✅ DRY (Don't Repeat Yourself)
- ✅ Easy to test
- ✅ Consistent version across app

### Developer Experience

**Before:**
- Manual script tag management
- Copy-paste code
- Difficult to customize

**After:**
- ✅ Import and use
- ✅ Reusable component
- ✅ Data attributes for configuration
- ✅ IDE autocomplete and type hints

## Testing

### Manual Testing

**Basic Generation:**
1. Navigate to page with QR code
2. Verify canvas renders with QR code
3. Scan with mobile device to verify URL

**Modal Lazy Loading:**
1. Open page with QR code modal
2. Verify QR code not generated immediately (check canvas)
3. Click button to open modal
4. Verify QR code generates when modal shown
5. Close and reopen modal - should not regenerate

**Download:**
1. Generate QR code
2. Click "Download" button
3. Verify PNG file downloads
4. Open file - verify QR code is correct

**Copy to Clipboard:**
1. Generate QR code
2. Click "Copy to Clipboard" button
3. Verify alert shows success
4. Paste into image editor - verify QR code copied

**Custom Configuration:**
1. Test with different size values (128, 256, 512)
2. Test with custom colors
3. Test with different error correction levels
4. Verify all configurations render correctly

### Browser Compatibility

**Tested Browsers:**
- ✅ Chrome/Edge (latest)
- ✅ Firefox (latest)
- ✅ Safari (macOS/iOS)
- ✅ Mobile browsers (iOS/Android)

**Clipboard API:**
- Requires HTTPS in production
- Works in localhost for development
- Gracefully degrades if not supported

## Troubleshooting

### QR Code Not Generating

**Check:**
- Console for error messages
- `data-qrcode-url-value` is set and valid
- Canvas target exists and is connected
- npm packages are installed (`npm install`)
- Assets are compiled (`npm run dev` or `npm run watch`)

### Modal QR Code Not Appearing

**Check:**
- `data-qrcode-modal-id-value` matches modal ID
- Modal has `id` attribute set
- Bootstrap modal events are firing
- Canvas is inside modal body

### Download Not Working

**Check:**
- Browser allows downloads
- Canvas has rendered QR code
- Check browser console for errors
- Try different browser

### Clipboard Copy Failing

**Check:**
- Using HTTPS (required for Clipboard API in production)
- Browser supports Clipboard API
- User has granted permissions
- Check browser console for errors

## Future Enhancements

**Potential Improvements:**

1. **SVG Output:** Support SVG format in addition to canvas
2. **Logo Embedding:** Add logo/image to center of QR code
3. **Color Gradients:** Support gradient fills
4. **Animation:** Animated QR code generation
5. **Multiple Formats:** Generate QR codes in various formats (PNG, SVG, PDF)
6. **Print Optimization:** High-resolution output for printing
7. **Analytics:** Track QR code scans via redirect service

## Related Documentation

- [JavaScript Development](10-javascript-development.md) - Main JavaScript documentation
- [JavaScript Framework](10.1-javascript-framework.md) - Stimulus framework details
- [Gatherings System](4.6-gatherings-system.md) - Public landing pages using QR codes

---

## Quick Reference

**Basic QR Code:**
```html
<div data-controller="qrcode"
     data-qrcode-url-value="https://example.com">
    <canvas data-qrcode-target="canvas"></canvas>
</div>
```

**With Actions:**
```html
<button data-action="click->qrcode#download">Download</button>
<button data-action="click->qrcode#copyToClipboard">Copy</button>
```

**In Modal (Lazy):**
```html
<div data-controller="qrcode"
     data-qrcode-url-value="https://example.com"
     data-qrcode-modal-id-value="myModal">
    <canvas data-qrcode-target="canvas"></canvas>
</div>
```

**Configuration:**
- `url`: URL to encode (required)
- `size`: Canvas size in pixels (default: 256)
- `colorDark`: QR code color (default: #000000)
- `colorLight`: Background color (default: #ffffff)
- `errorCorrectionLevel`: L, M, Q, or H (default: M)
- `modalId`: Modal ID for lazy loading (optional)
