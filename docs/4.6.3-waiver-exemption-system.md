# Waiver Exemption/Attestation System

## Overview

The Waiver Exemption system allows users to attest that a waiver is not required for a specific gathering activity, providing a configurable reason for the exemption. This creates an audit trail of why waivers were not collected for specific activities.

## Database Schema

### `waivers_waiver_types` Table
- **New Column**: `exemption_reasons` (TEXT, nullable)
  - Stores a JSON array of valid exemption reasons
  - Example: `["Pre-approved by legal", "Not applicable for this activity", "Covered by existing waiver"]`
  - Empty or null means exemptions are not allowed for this waiver type

### `waivers_gathering_waiver_exemptions` Table
New table to track exemption records:
- `id` (INT, primary key, auto-increment)
- `gathering_activity_id` (INT, foreign key to gathering_activities)
- `waiver_type_id` (INT, foreign key to waivers_waiver_types)
- `reason` (VARCHAR 255, required) - The selected exemption reason
- `member_id` (INT, foreign key to members) - Who created the exemption
- `notes` (TEXT, nullable) - Optional additional notes
- `created` (DATETIME, required) - When the exemption was created

**Constraints**:
- Unique constraint on (gathering_activity_id, waiver_type_id) - only one exemption per activity/waiver combination
- Foreign keys with appropriate CASCADE/RESTRICT behavior

## Components

### Backend

#### Entities
1. **`WaiverType.php`**
   - Added `exemption_reasons` accessible field
   - Added `exemption_reasons_parsed` virtual field
   - `_getExemptionReasonsParsed()` method returns parsed JSON array

2. **`GatheringWaiverExemption.php`**
   - New entity for exemption records
   - Properties: activity_id, waiver_type_id, reason, member_id, notes, created

#### Table Classes
1. **`WaiverTypesTable.php`**
   - Added `hasMany` relationship to `GatheringWaiverExemptions`
   - Validation for `exemption_reasons` field (must be array of non-empty strings)

2. **`GatheringWaiverExemptionsTable.php`**
   - New table class with associations to GatheringActivities, WaiverTypes, Members
   - Validation for required fields
   - `uniqueExemption` rule prevents duplicate exemptions

#### Controllers
**`GatheringWaiversController.php`**
- New `attest()` action:
  - Accepts POST with gathering_activity_id, waiver_type_id, gathering_id, reason, notes
  - Validates authorization (user must be able to edit the gathering)
  - Verifies the activity belongs to the gathering
  - Validates the reason is in the waiver type's configured exemption_reasons
  - Prevents duplicate exemptions
  - Creates and saves GatheringWaiverExemption record
  - Returns JSON response (success/error)

#### View Cells
**`GatheringWaiversCell.php`**
- Modified `display()` method to:
  - Load exemption records for the gathering
  - Add 'exemption' key to waiverRows structure
  - Add 'exempted' count to overallStats

### Frontend

#### Templates

1. **`display.php`** (Waivers template)
   - Shows exemption badge with tooltip for exempted waivers
   - "Attest Not Needed" button appears only for:
     - Waivers with status "Pending"
     - Waiver types that have exemption_reasons configured
   - Includes `waiver_attestation_modal` element

2. **`waiver_attestation_modal.php`**
   - Bootstrap modal with:
     - Dynamic reason radio button list
     - Optional notes textarea
     - Error/success alert containers
     - Submit button with Stimulus action bindings

3. **`add.php` and `edit.php`** (WaiverTypes forms)
   - Dynamic exemption reasons management section
   - Add/remove reason inputs
   - JSON storage in hidden field
   - Helpful instructions for administrators

#### JavaScript Controllers

1. **`waiver-attestation-controller.js`**
   - Manages attestation modal display and form submission
   - `showModal()`: Opens modal, populates with waiver data
   - `populateReasons()`: Builds radio button list from waiver type's reasons
   - `submitAttestation()`: AJAX POST to /waivers/gathering-waivers/attest
   - Handles CSRF tokens, error/success feedback, page reload

2. **`exemption-reasons-controller.js`**
   - Manages dynamic list of exemption reasons in WaiverTypes forms
   - `addReason()`: Adds new reason input field
   - `removeReason()`: Removes reason field (keeps at least one)
   - `reasonChanged()`: Updates hidden JSON field, auto-adds new field when last one is filled
   - Automatic focus management for better UX

## User Flow

### Attesting No Waiver Needed

1. User navigates to Gathering Waivers tab on a gathering detail page
2. For activities with pending waivers that have exemption reasons configured, an "Attest Not Needed" button appears
3. Clicking the button opens a modal showing:
   - Activity name
   - Waiver type name
   - List of configurable reasons (radio buttons)
   - Optional notes field
4. User selects a reason and optionally adds notes
5. User clicks "Attest Not Needed"
6. System validates:
   - User has permission to edit the gathering
   - Activity belongs to the gathering
   - Selected reason is valid for this waiver type
   - No duplicate exemption exists
7. On success:
   - Exemption record is created
   - Page reloads to show updated status
   - Waiver row now shows "Exempted" badge with tooltip showing reason

### Configuring Exemption Reasons

1. Administrator navigates to Waiver Types add/edit form
2. Scrolls to "Exemption Reasons" section
3. Adds reasons using dynamic input fields:
   - Type reason text and press Enter or Tab
   - System automatically adds a new empty field
   - Remove reasons using the X button
4. Save the waiver type
5. Reasons are stored as JSON array in database
6. When empty, no "Attest Not Needed" button appears for this waiver type

## Display Logic

### Waiver Status Badge
- **Uploaded**: Blue badge - waiver has been uploaded
- **Exempted**: Warning badge with info icon - exemption created, tooltip shows reason
- **Pending**: No badge - waiver needs to be uploaded or exempted

### Button Visibility
"Attest Not Needed" button appears when ALL conditions are met:
1. Waiver status is "Pending" (no upload, no exemption)
2. Waiver type has `exemption_reasons` configured (non-empty array)
3. User viewing the page (button triggers modal with current user context)

## Technical Details

### Validation Rules

**WaiverType.exemption_reasons**:
- Optional field (can be null or empty)
- Must be valid JSON array when present
- Each reason must be a non-empty string

**GatheringWaiverExemption**:
- `gathering_activity_id`: Required, must exist
- `waiver_type_id`: Required, must exist
- `reason`: Required, non-empty string, must be in waiver type's exemption_reasons
- `member_id`: Required, must exist
- `notes`: Optional text field
- `created`: Auto-populated timestamp
- Unique constraint: Only one exemption per (gathering_activity_id, waiver_type_id)

### Security

- Authorization checked via `Authorization->canEditGathering()`
- CSRF token required for all POST requests
- User identity captured in exemption record (member_id)
- Activity ownership validated (must belong to specified gathering)
- Reason validation prevents arbitrary text entry

### Data Integrity

- Foreign keys ensure referential integrity
- Unique constraint prevents duplicate exemptions
- CASCADE delete when activity or waiver type is deleted
- RESTRICT prevents deleting member who created exemption
- JSON validation ensures data quality for exemption_reasons

## Future Enhancements

Potential improvements for future iterations:

1. **Exemption Management**
   - View list of all exemptions for a gathering
   - Ability to revoke/delete exemptions
   - Exemption history with change log

2. **Reporting**
   - Report of exempted waivers by gathering/activity
   - Export exemption data for compliance audits

3. **Notifications**
   - Email notification when exemption is created
   - Alert gathering staff of exemptions

4. **Bulk Operations**
   - Apply same exemption reason to multiple activities at once
   - Copy exemptions from previous gathering

5. **Enhanced Validation**
   - Require manager approval for certain exemption reasons
   - Limit exemptions based on activity type or risk level

## Files Modified

### Database
- `/app/plugins/Waivers/config/Migrations/20251106163803_AddExemptionReasonsToWaiverTypes.php`
- `/app/plugins/Waivers/config/Migrations/20251106163826_CreateGatheringWaiverExemptions.php`

### Backend
- `/app/plugins/Waivers/src/Model/Entity/WaiverType.php`
- `/app/plugins/Waivers/src/Model/Entity/GatheringWaiverExemption.php`
- `/app/plugins/Waivers/src/Model/Table/WaiverTypesTable.php`
- `/app/plugins/Waivers/src/Model/Table/GatheringWaiverExemptionsTable.php`
- `/app/plugins/Waivers/src/Controller/GatheringWaiversController.php`
- `/app/plugins/Waivers/src/View/Cell/GatheringWaiversCell.php`

### Frontend Templates
- `/app/plugins/Waivers/templates/cell/GatheringWaivers/display.php`
- `/app/plugins/Waivers/templates/element/waiver_attestation_modal.php`
- `/app/plugins/Waivers/templates/WaiverTypes/add.php`
- `/app/plugins/Waivers/templates/WaiverTypes/edit.php`

### JavaScript
- `/app/plugins/Waivers/assets/js/controllers/waiver-attestation-controller.js`
- `/app/plugins/Waivers/assets/js/controllers/exemption-reasons-controller.js`
