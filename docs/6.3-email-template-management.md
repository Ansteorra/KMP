---
layout: default
---
[‚Üê Back to Services](6-services.md) | [‚Üê Back to Table of Contents](index.md)

# 6.3 Email Template Management System

**Last Updated:** February 11, 2026,  
**Status:** Active  
**Controllers:** `EmailTemplatesController`  
**Services:** `MailerDiscoveryService`, `EmailTemplateRendererService`

## Overview

The KMP Email Template Management System provides a centralized, database-driven approach to managing email templates. It allows administrators to edit email content through a user-friendly web interface without modifying code files, while maintaining full backward compatibility with file-based templates.

## Key Features

- **Database-Stored Templates**: Email templates are stored in the database, making them easy to update without deploying code changes
- **WYSIWYG Markdown Editor**: Uses EasyMDE for intuitive template editing with live preview
- **Variable Insertion**: Click-to-insert buttons for available variables in each template
- **Auto-Discovery**: Automatically discovers all Mailer classes and their methods using PHP reflection
- **Dual Format Support**: Create both HTML and plain text versions of emails
- **Template Fallback**: Falls back to file-based templates if database template is inactive
- **Conditional Logic**: `{{#if}}` blocks allow templates to show or hide content based on variable values ‚Äî no PHP execution, safe for admin editing
- **Authorization Integration**: Full RBAC support through EmailTemplatePolicy

## Architecture

### Database Schema

**Table:** `email_templates`

| Column | Type | Description |
|--------|------|-------------|
| `id` | INT | Primary key |
| `mailer_class` | VARCHAR(255) | Fully qualified class name (e.g., `App\Mailer\KMPMailer`) |
| `action_method` | VARCHAR(100) | Method name (e.g., `resetPassword`) |
| `subject_template` | VARCHAR(500) | Email subject with variable placeholders |
| `html_template` | TEXT | HTML version of the email (stored as Markdown) |
| `text_template` | TEXT | Plain text version of the email |
| `available_vars` | JSON | Array of available variables for this template |
| `is_active` | BOOLEAN | Whether to use this template instead of file-based template |
| `created` | DATETIME | Creation timestamp |
| `modified` | DATETIME | Last modification timestamp |

**Unique Constraint:** `(mailer_class, action_method)`

### Core Components

#### 1. MailerDiscoveryService

**Location:** `src/Services/MailerDiscoveryService.php`

Discovers all Mailer classes in core app and plugins using PHP reflection to:
- Find all classes extending `Cake\Mailer\Mailer`
- Analyze public methods and extract parameters
- Extract view variables set in the method
- Extract default subject lines from code
- Provide information for template creation and editing

**Key Methods:**
```php
public function discoverMailers(): array
public function discoverMailerMethods(string $mailerClass): array
public function extractAvailableVariables(string $mailerClass, string $method): array
```

#### 2. EmailTemplateRendererService

**Location:** `src/Services/EmailTemplateRendererService.php`

Renders templates by replacing variable placeholders with actual values:
- Processes `{{#if}}` conditional blocks before variable substitution
- Supports `{{variableName}}` and `${variableName}` syntax
- Converts Markdown to HTML for HTML templates
- Generates previews with sample data
- Handles missing variables gracefully

**Key Methods:**
```php
public function renderTemplate(EmailTemplate $template, array $variables): array
public function renderPreview(EmailTemplate $template): array
```

#### 3. TemplateAwareMailerTrait

**Location:** `src/Mailer/TemplateAwareMailerTrait.php`

The trait that integrates with CakePHP's Mailer pipeline:

```php
use App\Mailer\TemplateAwareMailerTrait;

class KMPMailer extends Mailer
{
    use TemplateAwareMailerTrait;
    // ... rest of class
}
```

**How it works:**
1. Intercepts the `render()` method before email generation
2. Checks database for active template matching the mailer class and action
3. If found, renders email from database template with provided variables
4. If not found or inactive, falls back to file-based templates in `templates/email/`
5. Logs template usage for debugging

**Template Precedence:**
1. **Active database template** - Used if `is_active = true`
2. **File-based template** - Used if no active database template exists
3. Falls back to file-based templates in:
   - `templates/email/html/{actionMethod}.php`
   - `templates/email/text/{actionMethod}.php`
   - `plugins/{Plugin}/templates/email/html/{actionMethod}.php`
   - `plugins/{Plugin}/templates/email/text/{actionMethod}.php`

#### 4. Model Layer

**EmailTemplatesTable** (`src/Model/Table/EmailTemplatesTable.php`)
- Validation rules for templates
- Unique constraint on (mailer_class, action_method)
- Helper methods for finding templates
- Business logic for template management

**EmailTemplate Entity** (`src/Model/Entity/EmailTemplate.php`)
- JSON encoding/decoding for available_vars
- Virtual field for display name
- Accessible properties configuration

#### 5. EmailTemplatesController

**Location:** `src/Controller/EmailTemplatesController.php`

**Actions:**
- `index()`: List all templates with filtering
- `view($id)`: View template details and preview
- `add()`: Create new template
- `edit($id)`: Edit existing template
- `delete($id)`: Delete template
- `discover()`: Show all discoverable mailer methods
- `sync()`: Auto-create templates for all discovered methods
- `preview($id)`: Generate template preview

#### 6. Frontend Components

**Stimulus Controller:** `assets/js/controllers/email-template-editor-controller.js`

Features:
- Extends EasyMDE markdown editor
- Adds variable insertion buttons
- Highlights variables in preview mode
- Provides toolbar for template editing
- Side-by-side editing and preview
- Fullscreen mode

**Views:** `templates/EmailTemplates/`
- `index.php`: Template listing with filters
- `form.php`: Add/edit form with dual editors (HTML + Text)
- `view.php`: Template details and preview
- `discover.php`: Mailer discovery interface

## User Guide

### For Administrators

#### Discovering Available Email Templates

1. Navigate to **Admin > Email Templates > Discover**
2. View all discovered mailer classes and their methods
3. See which methods have templates and which don't
4. Click "Create Template" for methods without templates

#### Creating a New Template

**Method 1: From Discovery Page**
1. Go to `/email-templates/discover`
2. Find the mailer method you want to template
3. Click "Create Template"
4. The form will be pre-populated with:
   - Mailer class and method
   - Available variables
   - Existing file-based template content (if any)
   - Default subject

**Method 2: Manual Creation**
1. Go to `/email-templates/add`
2. Select mailer class and action method from dropdowns
3. Available variables will be populated automatically

**Editing the Template:**
1. Enter subject template using variable placeholders
2. Edit plain text version using EasyMDE markdown editor
3. Edit HTML version using EasyMDE markdown editor
4. Click variable buttons to insert `{{variableName}}` placeholders
5. Check "Active" to use this template instead of file-based template
6. Click "Save"

#### Using the Editor

**Available Features:**

| Icon/Button | Function | Shortcut |
|-------------|----------|----------|
| **B** | Bold text | Ctrl+B |
| *I* | Italic text | Ctrl+I |
| H | Heading | - |
| " | Quote | - |
| ‚Ä¢ | Unordered list | - |
| 1. | Ordered list | - |
| üîó | Insert link | - |
| üëÅ | Toggle preview | - |
| ‚áÜ | Side-by-side | - |
| ‚õ∂ | Fullscreen | F11 |
| {} | Insert variable | - |
| ? | Guide | - |

**Variable Insertion:**
- Click any variable button above the editor to insert at cursor
- Variables shown as `{{variableName}}`
- Preview mode highlights variables in blue badges

**Example Template:**

*Plain Text:*
```
Hello {{memberName}},

Someone has requested a password reset for your account ({{email}}).

If this was you, please click the link below:
{{passwordResetUrl}}

If you did not request this, you can safely ignore this email.

{{siteAdminSignature}}
```

*HTML Template (Markdown):*
```markdown
Someone has requested a password reset for the **AMP** account associated with **{{email}}**.

If this was you, please click the link below to reset your password:

[Reset My Password]({{passwordResetUrl}})

If you did not request this, you can safely ignore this email.

---

{{siteAdminSignature}}
```

#### Synchronizing Templates

The "Sync" feature creates database records for all discovered mailer methods:

1. Click "Sync Templates" on the index page
2. System creates inactive templates for all methods without templates
3. Templates are created with:
   - Content from existing file-based templates (if any)
   - Default subject from code
   - Available variables detected from code
   - **Inactive status** (won't be used until you activate them)
4. Review and activate templates individually after testing

#### Previewing Templates

- View page shows preview with placeholder values
- Variables are shown as `[variableName]`
- Both HTML and text versions are displayed
- Preview uses sample data to show how the email will look

### For Developers

#### Adding New Mailer Methods

When you create a new mailer method:

```php
public function welcomeEmail(string $to, string $userName, string $activationUrl): void
{
    $this->setTo($to)
        ->setFrom(StaticHelpers::getAppSetting('Email.SystemEmailFromAddress'))
        ->setSubject('Welcome to KMP!')
        ->setViewVars([
            'userName' => $userName,
            'activationUrl' => $activationUrl,
            'siteTitle' => StaticHelpers::getAppSetting('KMP.LongSiteTitle'),
        ]);
}
```

The system will:
1. Auto-discover this method via reflection
2. Extract available variables: `userName`, `activationUrl`, `siteTitle`
3. Extract subject: "Welcome to KMP!"
4. Make it available for template creation in the admin interface

#### Using the Trait

All mailer classes should use the trait:

```php
<?php
declare(strict_types=1);

namespace App\Mailer;

use App\Mailer\TemplateAwareMailerTrait;
use Cake\Mailer\Mailer;

class MyMailer extends Mailer
{
    use TemplateAwareMailerTrait;
    
    // Your mailer methods...
}
```

#### Variable Syntax in Templates

Templates support two variable syntaxes:
- `{{variableName}}` - Primary syntax (recommended, shown in UI)
- `${variableName}` - Alternative syntax (also supported)

Variables are replaced when the email is rendered. Both syntaxes work identically.

#### Conditional Logic in Templates

Database-stored templates support conditional blocks using a mustache-like `{{#if}}` syntax. This lets templates show or hide content based on variable values without any PHP execution ‚Äî the syntax is parsed as a safe DSL using regex and string comparison.

**Supported Syntax:**

| Syntax | Description |
|--------|-------------|
| `{{#if varName == "value"}}...{{/if}}` | Show content when variable equals value |
| `{{#if varName != "value"}}...{{/if}}` | Show content when variable does NOT equal value |
| `{{#if a == "x" \|\| b == "y"}}...{{/if}}` | OR ‚Äî show content when either condition is true |
| `{{#if a == "x" && b == "y"}}...{{/if}}` | AND ‚Äî show content when both conditions are true |

**Processing Order:** Conditionals are processed BEFORE variable substitution by `EmailTemplateRendererService::processConditionals()`. This means `{{variable}}` placeholders inside conditional blocks work normally.

**Important Notes:**
- No `eval()` or PHP execution ‚Äî this is a safe pattern language using regex
- Variable names in conditions do **not** need a `$` prefix (it is stripped automatically if present)
- All comparisons are string-based
- `&&` (AND) has higher precedence than `||` (OR), matching standard boolean logic
- Unsupported expressions log a warning and evaluate to `false`

**Example ‚Äî Authorization Notification with Status-Based Content:**

```hbs
Hello {{memberScaName}},

Your authorization for {{authorizationType}} has been updated.

{{#if status == "Approved"}}
Congratulations! Your authorization has been approved and is now active.
Your authorization is valid from {{startDate}} to {{expiryDate}}.
{{/if}}

{{#if status == "Revoked"}}
Your authorization has been revoked as of {{revokedDate}}.
If you believe this is an error, please contact your group's officer.
{{/if}}

{{#if status != "Approved"}}
If you have questions about this decision, please reach out to your local officer.
{{/if}}

{{siteAdminSignature}}
```

**Auto-Conversion on Sync/Import:**

When file-based templates containing PHP conditionals are imported via the Sync feature, the `convertTemplateVariables()` method in `EmailTemplatesController` automatically converts PHP conditional syntax to `{{#if}}` syntax:

| File-Based PHP Syntax | Converted Database Syntax |
|----------------------|---------------------------|
| `<?php if ($status == "Approved") : ?>` | `{{#if status == "Approved"}}` |
| `<?php endif; ?>` | `{{/if}}` |
| `<?= $memberName ?>` | `{{memberName}}` |
| `<?= h($memberName) ?>` | `{{memberName}}` |

This conversion happens during sync so that administrators can edit the template using the clean `{{#if}}` syntax in the web interface.

#### Markdown Formatting Reference

**Text Formatting:**
- `**bold**` ‚Üí **bold**
- `*italic*` or `_italic_` ‚Üí *italic*
- `` `code` `` ‚Üí `code`

**Headings:**
```markdown
# Heading 1
## Heading 2
### Heading 3
```

**Links:**
```markdown
[Link Text](http://example.com)
[Link with Variable]({{passwordResetUrl}})
```

**Lists:**
```markdown
- Unordered item 1
- Unordered item 2

1. Ordered item 1
2. Ordered item 2
```

**Other:**
```markdown
---                  (horizontal line)
> Quoted text        (blockquote)
```

**Paragraphs:** Leave a blank line between paragraphs for proper spacing.

## Authorization

The system uses `EmailTemplatePolicy` for authorization:

- `canIndex`: View template list
- `canView`: View template details
- `canCreate`: Create new templates
- `canUpdate`/`canEdit`: Edit templates
- `canDelete`: Delete templates
- `canDiscover`: View mailer discovery page
- `canSync`: Synchronize templates
- `canPreview`: Preview templates

All actions require appropriate permissions assigned to user roles via the RBAC system.

## Best Practices

### Template Design

1. **Always provide both HTML and text versions**
   - HTML for rich formatting
   - Text for email clients that don't support HTML or for user preference

2. **Use descriptive subjects**
   - Include variables to personalize: `Welcome {{userName}} to {{siteTitle}}`
   - Keep subject lines under 60 characters when possible

3. **Keep templates focused**
   - One template per mailer action
   - Don't try to handle multiple scenarios in one template

4. **Test before activating**
   - Use preview feature to check rendering
   - Test with real data if possible
   - Keep template inactive until verified

5. **Mobile-friendly**
   - Keep layouts simple
   - Text should be readable on small screens
   - Avoid complex HTML structures

### Variable Usage

1. **Use consistent naming**
   - Match variable names to `setViewVars()` in code exactly (case-sensitive)
   - Use camelCase for consistency

2. **Document in code**
   - Comment what variables are available
   - Include examples in docblocks

3. **Provide defaults**
   - Handle missing variables gracefully in code
   - Use fallback values in `setViewVars()`

### Migration Strategy

To migrate from file-based to database templates:

1. **Run Sync** - Creates inactive templates with file content
2. **Review and Edit** - Update content as needed in web interface
3. **Test** - Preview templates, test with actual emails
4. **Activate** - Enable templates one at a time
5. **Monitor** - Check logs for template usage
6. **Archive Files** - Keep file-based templates as backup

## Technical Details

### Variable Extraction

The system attempts to extract variables from mailer methods by:
1. Reading the source file
2. Finding `setViewVars()` calls using regular expressions
3. Parsing the array structure
4. Extracting variable names

The `EmailTemplateRendererService::extractVariables()` method also extracts variables from templates at render time:
- Finds `{{variable}}` and `${variable}` placeholders
- Excludes `{{#if ...}}` and `{{/if}}` control tags from the variable list
- Extracts variable names referenced in `{{#if}}` conditions (e.g., `status` from `{{#if status == "Approved"}}`)

This is done using regular expressions. While robust, it may miss:
- Variables set in loops
- Variables from complex expressions
- Variables set conditionally

**Solution:** Manually specify variables when creating templates if auto-detection misses any.

### Performance

- Template lookups are cached at the query level
- No performance impact when using file-based templates
- Minimal overhead for database template rendering
- Consider caching frequently-used templates for high-volume emails

### Logging

Template usage is logged at DEBUG level:
```php
Log::debug('Email rendered from database template', [
    'mailer_class' => 'App\Mailer\KMPMailer',
    'template_id' => 5,
    'action' => 'resetPassword',
]);
```

Check logs at `logs/debug.log` or `logs/error.log` for template-related messages.

## Troubleshooting

### Template Not Being Used

**Symptom:** File-based template still being used instead of database template

**Check:**
1. Is template active? (`is_active = 1`)
2. Does mailer class use the trait?
3. Are class and method names exact matches? (case-sensitive)
4. Check logs for errors or template usage messages
5. Clear application cache: `bin/cake cache clear_all`

### Variables Not Replacing

**Symptom:** Variables like `{{userName}}` appear literally in sent emails

**Check:**
1. Variable names match exactly (case-sensitive)
2. Variables are set in `setViewVars()` in the mailer method
3. Syntax is correct: `{{variableName}}` with no spaces
4. No typos in variable names
5. Check logs for rendering errors

### Discovery Not Finding Mailers

**Symptom:** Mailer classes don't appear in discovery page

**Check:**
1. Mailer class extends `Cake\Mailer\Mailer`
2. Class is not abstract
3. Methods are public (not private or protected)
4. File is in correct location:
   - `src/Mailer/` for app
   - `plugins/{Plugin}/src/Mailer/` for plugins
5. Class is properly namespaced

### Editor Not Loading

**Symptom:** Markdown editor doesn't appear or has errors

**Check:**
1. Ensure assets are compiled: `npm run dev` or `npm run production`
2. Check browser console for JavaScript errors
3. Verify EasyMDE is in package.json dependencies
4. Clear browser cache
5. Check Content Security Policy settings don't block editor scripts

### Preview Not Showing

**Symptom:** Preview doesn't display when editing template

**Check:**
1. Click the eye icon (üëÅ) to enable preview mode
2. Try side-by-side mode (‚áÜ) to see both views
3. Check for JavaScript errors in browser console
4. Verify template has content in the editor

## Common Variables Reference

Depending on the email type, you may have access to:

| Variable | Description | Example |
|----------|-------------|---------|
| `{{email}}` | Recipient's email address | `user@example.com` |
| `{{memberName}}` | Member's full name | `John Smith` |
| `{{scaName}}` | Member's SCA name | `Lord John of Example` |
| `{{userName}}` | User's username | `johnsmith` |
| `{{passwordResetUrl}}` | Link to reset password | `https://kmp.example.com/...` |
| `{{siteAdminSignature}}` | Standard admin signature | `Thank you\nWebminister` |
| `{{siteTitle}}` | Site title | `Kingdom Management Portal` |
| `{{gatheringName}}` | Name of a gathering/event | `Winter Festival` |
| `{{activityName}}` | Name of an activity | `Heavy Combat` |
| `{{branchName}}` | Name of a branch | `Kingdom of Example` |

**Note:** Available variables vary by email type. Always check the "Available Variables" section above each editor when creating/editing templates.

## Future Enhancements

Potential improvements for future versions:

- **Template Versioning**: Track changes and revert to previous versions
- **A/B Testing**: Test different template variations
- **Template Inheritance**: Shared snippets/headers/footers (note: `{{#if}}` conditionals address some use cases, but shared layout blocks are a separate concept)
- **Rich HTML Editor**: WYSIWYG option in addition to Markdown
- **Email Testing**: Send test emails from the interface
- **Import/Export**: Backup and restore templates
- **Template Categories**: Organize templates by category or tag
- **Multi-language Support**: Localized templates
- **Template Scheduling**: Schedule template changes for specific dates
- **Usage Analytics**: Track template performance and open rates

## Related Documentation

- **[6. Services](6-services.md)** - Overview of all KMP services
- **[6.1 Email Service](6-services.md#61-email-service)** - Email sending and queueing
- **[4.4 RBAC Security Architecture](4.4-rbac-security-architecture.md)** - Authorization system
- **[7.3 Testing Infrastructure](7.3-testing-infrastructure.md)** - Testing email functionality

---

[‚Üê Back to Services](6-services.md) | [‚Üê Back to Table of Contents](index.md)
