# Implementation Plan: Gathering Waiver Tracking System

**Branch**: `001-build-out-waiver` | **Date**: 2025-10-19 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/workspaces/KMP/specs/001-build-out-waiver/spec.md`

**Note**: This document was generated by the `/speckit.plan` command and will be progressively filled through Phase 0 (Research) and Phase 1 (Design).

## Summary

The Gathering Waiver Tracking System enables Kingdom officers and gathering stewards to manage legal waivers for SCA gatherings (tournaments, practices, feasts, etc.). The system supports:

1. **Configuration**: Define Waiver Types (with retention policies), Gathering Types, and Gathering Activities with their waiver requirements
2. **Gathering Management**: Create gatherings with activities, automatically determining required waivers
3. **Image-to-PDF Conversion**: Upload waiver images (JPEG, PNG, TIFF) via web or mobile camera, automatically convert to compressed black and white PDF
4. **Mobile-First**: HTML5 camera capture for on-site waiver collection using phones/tablets  
5. **Retention Management**: Capture retention policies at upload time, identify waivers eligible for deletion
6. **Search & Reporting**: Search gatherings and generate compliance reports

**Core Architecture Decisions**:
- **Core Entities**: Gathering, Gathering Type, Gathering Activity (broadly reusable across plugins)
- **Waivers Plugin**: Contains waiver-specific entities (Waiver Type, Gathering Activity Waiver, Gathering Waiver)
- **Awards Migration**: Migrate `award_gatherings` table to core Gathering entity, refactor Awards plugin
- **Storage Optimization**: Image-to-PDF conversion reduces storage by 60-80%

## Technical Context

**Language/Version**: PHP 8.1+  
**Primary Dependencies**: CakePHP 5.x, Hotwired (Turbo + Stimulus.JS), Bootstrap, Laravel Mix  
**Storage**: MySQL 5.7+ or MariaDB 10.2+  
**Testing**: PHPUnit (PHP), Playwright (UI tests - optional)  
**Target Platform**: Web application (responsive, multi-browser)
**Project Type**: Web application (CakePHP MVC+ with plugins)  
**Architecture**: Plugin-based modular architecture, Service layer for business logic, Turbo Frames for partial updates  
**Performance Goals**: Standard web application performance; <500ms page load, efficient database queries, fast partial updates via Turbo  
**Constraints**: CakePHP conventions, PSR-12 coding standards, multi-tenant SCA kingdom support, Hotwired patterns for frontend  
**Scale/Scope**: Multi-kingdom deployment, thousands of members per kingdom, complex role-based permissions, multi-tab/multi-grid interfaces

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Verify compliance with KMP Constitution (`.specify/memory/constitution.md`):

- [x] **CakePHP Conventions**: 
  - Core entities in `src/Model/` (Gathering, GatheringType, GatheringActivity)
  - Plugin structure for Waivers in `plugins/Waivers/`
  - Controllers follow naming: `GatheringsController`, `GatheringTypesController`, `WaiverTypesController` (plugin)
  - Templates in lowercase snake_case: `gatherings/`, `gathering_types/`, etc.
  - Migrations for all schema changes
  
- [x] **Plugin Architecture**: 
  - Waivers implemented as **separate plugin** (`plugins/Waivers/`)
  - Core Gathering entities remain in core KMP for cross-plugin reusability
  - Plugin registration in `config/plugins.php` with migration order
  - NavigationProvider for menu integration
  - Independent plugin testing

- [x] **Hotwired Stack**: 
  - Turbo Frames for waiver upload interfaces (multi-tab scenarios: configuration → gathering creation → waiver uploads)
  - Turbo Streams for real-time upload progress and conversion feedback
  - Stimulus controllers for:
    - Mobile camera capture integration (`camera-capture-controller.js`)
    - Image validation (`image-validator-controller.js`)
    - Multi-file upload handling (`batch-upload-controller.js`)
    - Retention policy calculator UI (`retention-calculator-controller.js`)

- [x] **Test Coverage**: 
  - PHPUnit tests for all controllers (CRUD operations, authorization)
  - Model tests for entities and tables (validation, relationships)
  - Service tests for image-to-PDF conversion, retention calculation
  - Integration tests for full waiver upload workflow
  - Fixtures for gathering types, activities, waiver types

- [x] **Security & Authorization**: 
  - Policy classes: `GatheringPolicy`, `GatheringTypePolicy`, `GatheringActivityPolicy`, `WaiverTypePolicy`, `WaiverPolicy`
  - Role-based access: Kingdom officers configure; gathering stewards manage gatherings/uploads; compliance officers view/delete expired waivers
  - File access controls: Only authorized users can download waiver PDFs
  - Input validation: Image format validation, file size limits, retention policy structure validation

- [x] **Service Layer**: 
  - `ImageToPdfConversionService`: Handles image conversion to compressed black and white PDF
  - `RetentionPolicyService`: Calculates expiration dates, identifies eligible deletions
  - `WaiverStorageService`: Abstracts file storage (local/cloud)
  - `GatheringActivityService`: Determines required waivers based on selected activities
  - `AwardsMigrationService`: Handles data migration from `award_gatherings` to core `gatherings`

- [x] **Code Quality**: 
  - PSR-12 compliance via PHP_CodeSniffer
  - Type declarations (`declare(strict_types=1);`) throughout
  - PHPDoc blocks for all classes, methods, properties
  - ESLint for Stimulus controllers
  - Static analysis via PHPStan

**Justification for any deviations**: None - all constitution principles are followed.

## Project Structure

### Documentation (this feature)

```
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (KMP CakePHP Structure)

**For Core Features**:
```
app/
├── src/
│   ├── Controller/         # Controllers for this feature
│   ├── Model/
│   │   ├── Entity/        # Entity classes
│   │   └── Table/         # Table classes
│   ├── Services/          # Service layer for business logic
│   ├── Policy/            # Authorization policies
│   └── View/              # View cells and helpers
├── templates/             # View templates
├── assets/
│   ├── css/              # Feature-specific CSS
│   └── js/
│       └── controllers/  # Stimulus.JS controllers
├── tests/
│   └── TestCase/
│       ├── Controller/   # Controller tests
│       ├── Model/        # Model tests
│       └── Service/      # Service tests
└── config/
    └── Migrations/       # Database migrations
```

**For Plugin-Based Features**:
```
app/plugins/[FeatureName]/
├── src/
│   ├── [FeatureName]Plugin.php  # Main plugin class
│   ├── Controller/              # Plugin controllers
│   ├── Model/                   # Plugin models
│   ├── Services/                # Plugin services (including NavigationProvider)
│   ├── Event/                   # Event listeners (CallForCellsHandler, etc.)
│   └── Policy/                  # Plugin authorization policies
├── templates/                   # Plugin templates
├── assets/
│   ├── css/                     # Plugin CSS
│   └── js/
│       └── controllers/         # Plugin Stimulus controllers
├── tests/                       # Plugin tests
├── config/
│   ├── Migrations/              # Plugin migrations
│   └── bootstrap.php            # Plugin bootstrap
└── webroot/                     # Plugin public assets
```

## Project Structure Decision

**Structure Decision**: **Plugin-Based Feature** with **Core Entities**

**Rationale**: 
This feature requires a **hybrid approach** as clarified in the specification:

1. **Core Entities** (in `src/Model/`):
   - `Gathering`, `GatheringType`, `GatheringActivity` - These are broadly reusable across KMP (not just waivers)
   - Enables future features to leverage gatherings (e.g., attendance tracking, event announcements, photo galleries)
   - Follows CakePHP convention: shared domain models live in core application
   
2. **Waivers Plugin** (in `plugins/Waivers/`):
   - `WaiverType`, `GatheringActivityWaiver`, `GatheringWaiver`, `WaiverConfiguration` - Waiver-specific entities
   - Self-contained waiver management logic (upload, conversion, retention, deletion)
   - Independent testing and potential distribution to other SCA chapters
   - Follows plugin architecture principle: feature is cohesive and could be disabled/enabled independently

3. **Data Migration** (one-time):
   - Migrate `award_gatherings` data to new core `gatherings` table
   - Update Awards plugin to reference core `gatherings` instead of plugin-specific table
   - Ensures gatherings become a shared resource across all plugins

This structure balances **reusability** (core gatherings) with **modularity** (waiver logic in plugin).

## Complexity Tracking

**Estimated Story Points**: **21**

**Complexity Factors**:
- **High Complexity**:
  - Image-to-PDF conversion with black and white compression (library evaluation, quality tuning)
  - Mobile camera HTML5 integration (cross-device testing, permission handling)
  - Data migration from `award_gatherings` to core `gatherings` (Awards plugin refactoring)
  - Configurable retention policies with JSON schema validation
  - Multi-tab Turbo Frames workflow (configuration → gathering → activities → waivers)
  - Automated retention policy execution with safe deletion
  
- **Medium Complexity**:
  - Plugin architecture setup with NavigationProvider
  - RBAC policies for multiple roles (officers, stewards, compliance)
  - Search and reporting UI with multiple filter criteria
  - File storage abstraction (local/cloud)
  - Comprehensive test coverage (unit, integration, UI)
  
- **Low Complexity**:
  - Standard CRUD for configuration entities (Waiver Types, Gathering Types, Activities)
  - CakePHP form validation and entity management
  - Bootstrap UI components for mobile-first design

**Risk Assessment**: **Medium-High**

**High-Risk Areas**: 
1. **Image Conversion Quality**: Achieving acceptable quality in compressed black and white PDFs while keeping file sizes small
2. **Mobile Camera Compatibility**: HTML5 camera API behavior varies across devices/browsers (iOS Safari, Android Chrome)
3. **Awards Migration**: Safely migrating existing gathering data without breaking Awards plugin functionality
4. **Retention Policy Bugs**: Incorrect date calculations could lead to premature deletion of legal documents
5. **Storage Backend Switching**: Configurable storage must handle existing files gracefully during backend changes
6. **Performance**: PDF conversion for batch uploads of 20+ images per gathering needs optimization

**Constitution Compliance**: No violations - all constitution principles are followed

---

## Phase Completion Status

### ✅ Phase 0: Research (COMPLETE)

**Output**: `research.md`

All technical unknowns have been researched and resolved:
- ✅ Image-to-PDF conversion library selected (Imagick with Group4 compression)
- ✅ Mobile camera integration approach determined (HTML5 file input with `capture="environment"`)
- ✅ Black and white compression technique decided (Group4/CCITT T.6)
- ✅ Storage backend abstraction designed (Flysystem)
- ✅ Mobile-first UI patterns defined (Turbo Frame wizard)
- ✅ Retention policy date calculation approach (CakePHP FrozenTime)
- ✅ Automated deletion implementation strategy (Queue Plugin job)

**Key Decisions**:
- **Image Library**: Imagick (ImageMagick PHP extension) for best compression control
- **Mobile Pattern**: HTML5 `<input capture="environment">` for simplicity and reliability
- **Storage**: Flysystem for flexible local/S3 storage
- **Date Handling**: CakePHP FrozenTime (immutable, handles edge cases)
- **Automation**: Queue Plugin with two-step deletion process (mark → review → delete)

### ✅ Phase 1: Design (COMPLETE)

**Outputs**:
1. ✅ `data-model.md` - Complete entity definitions with ERD
2. ✅ `contracts/` - API endpoint specifications
   - `README.md` - API conventions and patterns
   - `gathering-types.md` - Core gathering types endpoints
   - `gatherings.md` - Core gatherings endpoints  
   - `gathering-waivers.md` - Plugin waiver upload/management endpoints
3. ✅ `quickstart.md` - Developer onboarding guide

**Data Model Summary**:
- **7 entities**: 3 core (GatheringTypes, Gatherings, GatheringActivities), 4 plugin (WaiverTypes, GatheringActivityWaivers, GatheringWaivers, WaiverConfiguration)
- **Complete ERD** with all relationships, foreign keys, indexes
- **Migration strategy** documented for Awards plugin data migration

**API Contracts**:
- RESTful endpoints following CakePHP conventions
- Turbo Frame/Stream integration patterns
- Mobile upload workflow documented
- Authorization rules per endpoint

**Quickstart Guide**:
- Prerequisites (Imagick, Flysystem)
- Step-by-step setup instructions
- Code patterns for Turbo, Stimulus, Services, Policies
- Testing strategy
- Common commands reference

### ⏭️ Phase 2: Implementation Tasks (NEXT)

**Command**: `/speckit.tasks`

This command will generate `tasks.md` with granular development tasks organized by milestone:
- Milestone 1: Database setup (migrations, seeds)
- Milestone 2: Core entities (models, basic CRUD)
- Milestone 3: Plugin setup (Waivers plugin structure)
- Milestone 4: Image conversion service
- Milestone 5: Mobile UI (Stimulus controllers)
- Milestone 6: Retention policies
- Milestone 7: Testing
- Milestone 8: Awards migration

**Note**: Do NOT run `/speckit.tasks` until Phase 0 and Phase 1 are complete and reviewed. This plan document serves as the gate.

---

## Final Checklist Before Implementation

Before proceeding to create development tasks:

- [x] **Constitution Check Passed**: All 7 principles verified
- [x] **Phase 0 Research Complete**: All technical unknowns resolved
- [x] **Phase 1 Design Complete**: Data model, contracts, quickstart all generated
- [ ] **Spec Reviewed**: Feature spec has been reviewed and approved by stakeholders
- [ ] **Plan Reviewed**: This implementation plan has been reviewed and approved
- [ ] **Agent Context Updated**: Run `.specify/scripts/bash/update-agent-context.sh copilot` to update AI context

**Status**: ✅ Ready for task generation (`/speckit.tasks`)

---
